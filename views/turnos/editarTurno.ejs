<!DOCTYPE html>
<html lang="es">
<head>
    <!--HEAD-->
    <%- include('../commons/head') %>
    <link rel="stylesheet" href="/public/css/turnos.css">
</head>


<body>
    <div class="contenedor-flex">
        <div class="contenedor-barra-lateral">
            <!-- Mostrar el menú correspondiente basado en el idCategoriaUsuario -->
            <% if (categoria  === 1) { %>
                <%- include('../commons/barra-lateral-admin') %> <!-- Menú para administradores -->
            <% } else if (categoria  === 3) { %>
                <%- include('../commons/barra-lateral-secretarias') %> <!-- Menú para secretarias -->
            <% } else if (categoria === 2) { %>
                <%- include('../commons/barra-lateral-medicos') %> <!-- Menú para médicos -->
            <% } else { %>
                <p>No tienes permisos para ver este contenido.</p>
            <% } %>
        </div>
    
        <div class="contenedor-editar">
            <div class="container my-5 contenedor-agregar-turno">
                <div class="contenedor-titulo-boton">

                    <div>
                        <a href="/turnos" class="btn btn-volver"><i class="fa-solid fa-arrow-left"></i>  Volver a Turnos</a>
                    </div>

                    <h1 class="text-center mb-4">Editar Turno</h1>
                </div>
                <form class="formulario-editar-turno">
                    <div class="row mb-3">
                        <div class="col-md-3">
                        <label for="medico_nombre" class="form-label">Médico</label>
                        <select class="form-select" id="medico_nombre" name="medico_nombre">
                            <% medicos.forEach((medico) => { %>
                            <option value="<%= medico.id %>" <%= turno.id_medico == medico.id ? 'selected' : '' %> >
                                <%= medico.nombre_medico %>
                            </option>
                            <% }) %>
                        </select>
                        </div>

                        <div class="col-md-3">
                        <label for="paciente_nombre" class="form-label">Paciente</label>
                        <select class="form-select" id="paciente_nombre" name="paciente_nombre">
                            <% pacientes.forEach((paciente) => { %>
                            <option value="<%= paciente.id %>" <%= turno.id_paciente == paciente.id ? 'selected' : '' %> >
                                <%= paciente.nombre %>
                            </option>
                            <% }) %>
                        </select>
                        </div>

                        <div class="col-md-3">
                        <label for="practica" class="form-label">Práctica</label>
                        <select class="form-select" id="practica" name="practica">
                            <% practicas.forEach((practica) => { %>
                            <option value="<%= practica.id %>" <%= turno.id_practica == practica.id ? 'selected' : '' %> >
                                <%= practica.nombre %>
                            </option>
                            <% }) %>
                        </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <% let date = new Date(turno.fecha_hora); %>
                        <div class="col-md-3">
                            <label for="fecha" class="form-label">Fecha</label>
                            <input class="form-control" type="date" id="fecha" value="<%= date.getFullYear() %>-<%= (date.getMonth() + 1).toString().padStart(2, '0') %>-<%= date.getDate().toString().padStart(2, '0') %>">
                        </div>

                        <div class="col-md-3">
                            <label for="hora" class="form-label">Hora</label>
                            <input class="form-control" type="time" id="hora" value="<%= date.getHours().toString().padStart(2, '0') %>:<%= date.getMinutes().toString().padStart(2, '0') %>">
                        </div>

                        <div class="col-md-3">
                            <label for="id_estadoTurno" class="form-label">Estado</label>
                            <select class="form-select" id="id_estadoTurno" name="estado_turno">
                                <% estado_turnos.forEach((estado_turno) => { %>
                                <option value="<%= estado_turno.id %>" <%= estado_turno.id == turno.id_estadoTurno ? 'selected' : '' %> >
                                    <%= estado_turno.estado_nombre %>
                                </option>
                                <% }) %>
                            </select>
                        </div>
                    </div>

                    <div class="d-flex botones gap-2 mt-3">
                        <a href="/turnos" class="btn btn-cancelar text-decoration-none">Cancelar</a>
                        <button type="button" class="btn btn-guardar guardar">Guardar</button>
                    </div>
                    </form>

        
            </div>
        </div>
    </div>



    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SweetAlert JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const botonGuardar = document.querySelector(".guardar");

        botonGuardar.addEventListener("click", async () => {
        const turnoMedico = document.querySelector("#medico_nombre").value;
        const turnoPaciente = document.querySelector("#paciente_nombre").value;
        const turnoPractica = document.querySelector("#practica").value;
        const turnoFecha = document.querySelector("#fecha").value;
        const turnoHora = document.querySelector("#hora").value;
        const fechaCompleta = `${turnoFecha} ${turnoHora}`;
        const turnoId_estadoTurno = document.querySelector("#id_estadoTurno").value;

        // Validación previa
        if (!turnoMedico || !turnoPaciente || !turnoFecha || !turnoHora || !turnoId_estadoTurno) {
            Swal.fire({
            icon: 'warning',
            title: 'Campos incompletos',
            text: 'Por favor, complete todos los campos antes de continuar.',
            confirmButtonColor: '#f27474',
            confirmButtonText: 'Ok',
            backdrop: true,
            });
            return;
        }

        // Confirmación antes de guardar
        const confirm = await Swal.fire({
            title: '¿Guardar cambios?',
            text: "Se actualizará la información del turno.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sí, guardar',
            cancelButtonText: 'Cancelar',
            backdrop: true,
        });

        if (!confirm.isConfirmed) {
            return;
        }

        const datos = {
            id: <%= turno.id %>,
            id_medico: turnoMedico,
            id_paciente: turnoPaciente,
            id_practica: turnoPractica,
            fecha_hora: fechaCompleta,
            id_estadoTurno: turnoId_estadoTurno,
        };

        try {
            const results = await fetch('/turnos/editar/<%= turno.id %>', {
            method: 'POST',
            body: JSON.stringify(datos),
            headers: {
                'Content-Type': 'application/json'
            }
            });

            const data = await results.json();
            if (data.success) {
            await Swal.fire({
                icon: 'success',
                title: 'Turno actualizado',
                text: 'Los cambios se guardaron correctamente.',
                showConfirmButton: true,
                confirmButtonColor: '#28a745',
                confirmButtonText: 'Ir a Turnos',
                timer: 2500,
                timerProgressBar: true,
                backdrop: true,
            });
            location.href = "/turnos";
            } else {
            Swal.fire({
                icon: 'error',
                title: 'Error al guardar',
                text: 'Verifica la información e inténtalo nuevamente.',
                confirmButtonColor: '#d33',
            });
            }
        } catch (error) {
            console.error("Error:", error);
            Swal.fire({
            icon: 'error',
            title: 'Error inesperado',
            text: 'Ocurrió un error al intentar guardar el turno.',
            confirmButtonColor: '#d33',
            });
        }
        });

    </script>
</body>
</html>