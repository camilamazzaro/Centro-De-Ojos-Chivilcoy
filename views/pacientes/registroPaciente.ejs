<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Paciente</title>
    <link rel="stylesheet" href="/public/css/pacientes.css">
    <%- include('../commons/head') %>
</head>

<body>
    <div class="contenedor-flex contenedor-registro-pacientes">

        <div class="contenedor-logo-lateral">
            <div class="texto-bienvenida">
                <div class="logo"></div>
            </div>
            

            <svg id="fondoWave" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="#005b6f" fill-opacity="1" d="M0,224L60,202.7C120,181,240,139,360,101.3C480,64,600,32,720,58.7C840,85,960,171,1080,181.3C1200,192,1320,128,1380,96L1440,64L1440,320L1380,320C1320,320,1200,320,1080,320C960,320,840,320,720,320C600,320,480,320,360,320C240,320,120,320,60,320L0,320Z"></path></svg>
        </div>

        
        <!-- PASO 1: INFORMACIÓN PERSONAL -->
        <div class="container-pasoUno">

            <div class="proceso-agregar-paciente">
                <h1 style="text-align: center;">Registrarse</h1>

                    <!-- Diagrama de Proceso -->
                    <div class="diagrama-proceso">
                        <div class="paso" id="paso1">
                            <div class="circulo circulo-activo" id="circulo-paso1">1</div>
                            <span>Información Personal</span>
                        </div>
                        <div class="paso" id="paso2">
                            <div class="circulo" id="circulo-paso2">2</div>
                            <span>Información Médica</span>
                        </div>
                        <div class="paso" id="paso3">
                            <div class="circulo" id="circulo-paso3">3</div>
                            <span>Revisión</span>
                        </div>
                    </div>

                    <!-- datos del cliente -->
                    <div class="formulario-proceso">

                        <div class="row">
                            <div class="form-group col-md-6">
                                <!-- Input oculto para capturar el id_usuario -->
                                <!-- <input type="hidden" name="id_usuario" id="idUsuario" value="<%= // idUsuario || '' %>"> -->
                            </div>
                        </div>

                        <div class="row">
                            <div class="form-group col-md-6">
                                <label for="nombre">Nombre</label>
                                <input type="text" name="nombre">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="apellido">Apellido</label>
                                <input type="text" name="apellido">
                            </div>
                        </div>

                        <div class="row">
                            <div class="form-group col-md-6">
                                <label for="dni">DNI</label>
                                <input type="text" name="dni">
                            </div>

                            <div class="form-group col-md-6">
                                <label for="genero">Género</label>
                                <select name="genero" id="genero">
                                    <option value="femenino">Femenino</option>
                                    <option value="masculino">Masculino</option>
                                    <option value="otro">Otro</option>
                                </select>
                            </div>
                            
                        </div>

                        <div class="row">
                            <div class="form-group col-md-6">
                                <label for="fecha_nacimiento">Fecha de nacimiento</label>
                                <input type="date" name="fecha_nacimiento">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="direccion">Dirección</label>
                                <input type="text" name="direccion">
                            </div>
                        </div>
            
                        <div class="row">
                            <div class="form-group col-md-6">
                                <label for="telefono">Teléfono</label>
                                <input type="text" name="telefono">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="email">Email</label>
                                <input type="email" name="email">
                            </div>
                        </div>

                    </div>
                

                    <button class="boton-siguiente boton-siguiente-paso-1 btn">
                        Siguiente
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>

            </div>
        
        </div>

        <!-- PASO 2: INFORMACIÓN MÉDICA -->
        <div class="container-pasoDos ocultar">

            <div class="proceso-agregar-paciente">

                <h1 style="text-align: center;">Agregar Paciente</h1>

                <div class="columna-izquierda">
                    <div class="logo"></div>

                    <!-- Diagrama de Proceso -->
                    <div class="diagrama-proceso">
                        <div class="paso" id="paso1">
                            <div class="circulo circulo-activo" id="circulo-paso1">1</div>
                            <span>Información Personal</span>
                        </div>
                        <div class="paso" id="paso2">
                            <div class="circulo circulo-activo" id="circulo-paso2">2</div>
                            <span>Información Médica</span>
                        </div>
                        <div class="paso" id="paso3">
                            <div class="circulo" id="circulo-paso3">3</div>
                            <span>Revisión</span>
                        </div>
                    </div>


                    <div class="formulario-proceso">

                        <div class="row">
                            <div class="form-group col-md-6">
                                <label for="cobertura">Cobertura</label>
                                <select name="cobertura" id="cobertura">
                                    <% obrasSociales.forEach(obras => { %>
                                        <option value="<%= obras.id %>"><%= obras.nombre %></option>
                                    <% }); %>
                                </select>

                            </div>
                            <div class="form-group col-md-6">
                                <label for="nro_afiliado">Nro. Afiliado</label>
                                <input type="text" name="nro_afiliado" id="">
                            </div>
                        </div>

                    </div>
                
                    <button class="boton-anterior boton-anterior-paso-2 btn">Anterior</button>
                    <button class="boton-siguiente boton-siguiente-paso-2 btn">
                        Siguiente
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>

                </div>
                
            </div>

        
        </div>

        <!-- PASO 3: CONTRAEÑA -->
        <div class="container-pasoTres ocultar">
            <div class="proceso-agregar-paciente">
                <h1 style="text-align: center;">Crear Contraseña</h1>

                <div class="columna-izquierda">
                    <div class="logo"></div>

                    <!-- Diagrama de Proceso -->
                    <div class="diagrama-proceso">
                        <div class="paso" id="paso1">
                            <div class="circulo circulo-activo" id="circulo-paso1">1</div>
                            <span>Información Personal</span>
                        </div>
                        <div class="paso" id="paso2">
                            <div class="circulo circulo-activo" id="circulo-paso2">2</div>
                            <span>Información Médica</span>
                        </div>
                        <div class="paso" id="paso3">
                            <div class="circulo circulo-activo" id="circulo-paso3">3</div>
                            <span>Contraseña</span>
                        </div>
                    </div>

                    <div class="formulario-proceso">
                        <div class="row">
                            <div class="form-group col-md-6">
                                <label for="password">Contraseña</label>
                                <input type="password" name="password" id="password">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="confirmar_password">Confirmar Contraseña</label>
                                <input type="password" name="confirmar_password" id="confirmar_password">
                            </div>
                        </div>

                        <div class="botones">
                            <button class="boton-anterior boton-anterior-paso-3 btn">Anterior</button>
                            <button class="boton-confirmar btn">Guardar Paciente</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    
    </div>

    <script>

        // IR GUARDANDO LA INFORMACIÓN DE A POCO Y LUEGO ENVIAR TODO JUNTO

        document.addEventListener("DOMContentLoaded", () => {

            // Al ingresar datos del paso 1
            document.querySelector(".boton-siguiente-paso-1").addEventListener("click", async () => {
                const nombre = document.querySelector("[name=nombre]").value.trim(); // trim() se utiliza para eliminar los espacios en blanco al principio y al final
                const apellido = document.querySelector("[name=apellido]").value.trim();
                const nombre_apellido = `${nombre} ${apellido}`;

                const dni = document.querySelector("[name=dni]").value.trim();
                const fecha_nacimiento = document.querySelector("[name=fecha_nacimiento]").value;
                const genero = document.querySelector("[name=genero]").value;
                const direccion = document.querySelector("[name=direccion]").value.trim();
                const telefono = document.querySelector("[name=telefono]").value.trim();
                const email = document.querySelector("[name=email]").value.trim();

                // Guardar en sessionStorage
                sessionStorage.setItem("nombre", nombre_apellido);
                sessionStorage.setItem("dni", dni);
                sessionStorage.setItem("fecha_nacimiento", fecha_nacimiento);
                sessionStorage.setItem("genero", genero);
                sessionStorage.setItem("direccion", direccion);
                sessionStorage.setItem("telefono", telefono);
                sessionStorage.setItem("email", email);

                // Enviamos datos al backend para guardarlos temporalmente
                await fetch("/pacientes/guardar-info-personal", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ nombre_apellido, dni, fecha_nacimiento, genero, direccion, telefono, email})
                });

            });

            // Guardar Paso 2
            
            document.querySelector(".boton-siguiente-paso-2").addEventListener("click", async () => {
                
                const cobertura = document.querySelector("[name=cobertura]").value;
                const nro_afiliado = document.querySelector("[name=nro_afiliado]").value.trim();

                sessionStorage.setItem("cobertura", cobertura);
                sessionStorage.setItem("nro_afiliado", nro_afiliado);

                await fetch("/pacientes/guardar-info-medica", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ cobertura, nro_afiliado})
                });

                //Cargar resumen desde Storage --> ESTO DESPUÉS PASARLO AL MISMO ÁMBITO DONDE ESTÁN LAS VALIDACIONES DEL PASO 2
                function cargarResumenDesdeStorage(){
                    console.log("Cargando datos del resumen...");

                    const nombre_apellido = sessionStorage.getItem("nombre") || "No especificado";
                    const dni = sessionStorage.getItem("dni") || "No especificado";
                    const fecha_nacimiento = sessionStorage.getItem("fecha_nacimiento") || "No especificado";
                    const genero = sessionStorage.getItem("genero") || "No especificado";
                    const direccion = sessionStorage.getItem("direccion") || "No especificado";
                    const email = sessionStorage.getItem("email") || "No especificado";
                    const telefono = sessionStorage.getItem("telefono") || "No especificado";
                    const nro_afiliado = sessionStorage.getItem("nro_afiliado") || "No especificado";

                    let cobertura = "No especificado";
                    const coberturaId = sessionStorage.getItem("cobertura");

                    if (coberturaId) {
                        const coberturaOption = document.querySelector(`#cobertura option[value="${coberturaId}"]`);
                        if (coberturaOption) {
                            cobertura = coberturaOption.textContent;
                        }
                    }
                    

                    //Mostrar datos en el resumen (paso 3)
                    document.getElementById("resumen-nombre").textContent = nombre_apellido;
                    document.getElementById("resumen-dni").textContent = dni;
                    document.getElementById("resumen-fecha-nacimiento").textContent = fecha_nacimiento;
                    document.getElementById("resumen-genero").textContent = genero;
                    document.getElementById("resumen-direccion").textContent = direccion;
                    document.getElementById("resumen-email").textContent = email;
                    document.getElementById("resumen-telefono").textContent = telefono;
                    document.getElementById("resumen-cobertura").textContent = cobertura;
                    document.getElementById("resumen-nro-afiliado").textContent = nro_afiliado;

                    console.log("Resumen actualizado.")
                }

                // Llamamos a la función para cargar el resumen (paso 3)
                cargarResumenDesdeStorage();
            })

            // Cuando se toca el botón de guardar, se envían todos los datos recopilados

            document.querySelector(".boton-confirmar").addEventListener("click", async () => {

                const password = document.querySelector("#password").value;
                const confirmarPassword = document.querySelector("#confirmar_password").value;

                if(password !== confirmarPassword){
                    return Swal.fire("Las contraseñas no coinciden");
                }

                const nombre_apellido = sessionStorage.getItem("nombre") || "";
                const dni = sessionStorage.getItem("dni") || "";
                const fecha_nacimiento = sessionStorage.getItem("fecha_nacimiento") || "";
                const genero = sessionStorage.getItem("genero") || "";
                const direccion = sessionStorage.getItem("direccion") || "";
                const email = sessionStorage.getItem("email") || "";
                const telefono = sessionStorage.getItem("telefono") || "";
                const cobertura = sessionStorage.getItem("cobertura") || "";
                const nro_afiliado = sessionStorage.getItem("nro_afiliado") || "";

                const payload = JSON.stringify({
                    nombre_apellido,
                    dni,
                    fecha_nacimiento,
                    genero,
                    direccion,
                    email,
                    telefono,
                    cobertura,
                    nro_afiliado,
                    password
                });

                console.log("Enviando datos al back: ", payload);

                try {
                    const response = await fetch("/pacientes/agregar/0", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: payload
                    });

                    const result = await response.json();
                    console.log("Respuesta del servidor: ", result);

                    if (result.error === 0) {
                        Swal.fire({
                            title: 'Paciente guardado con éxito',
                            text: result.message || 'Paciente guardado correctamente.',
                            icon: 'success',
                            confirmButtonText: 'Aceptar'
                        }).then(() => {
                            window.location.href = "/loginPacientes";
                        });
                    } else {
                        Swal.fire({
                            title: 'Error',
                            text: result.message || 'No se pudo guardar el paciente.',
                            icon: 'error',
                            confirmButtonText: 'Aceptar'
                        });
                    }

                } catch (error) {
                    console.error("Error al guardar paciente:", error);
                    Swal.fire({
                        title: 'Error inesperado',
                        text: 'Ocurrió un error al guardar el paciente.',
                        icon: 'error',
                        confirmButtonText: 'Aceptar'
                    });
                }
            });


        })

        // PARA MOSTRAR LOS PASOS DE A POCO
        document.addEventListener("DOMContentLoaded", function(){
            let pasoActual = 1;

            function mostrarPaso(paso) {
                document.querySelectorAll('.container-pasoUno, .container-pasoDos, .container-pasoTres').forEach((container, index) => {
                    container.style.display = (index + 1 === paso) ? 'block' : 'none';
                });
            }

            // Mostrar el primer paso al cargar
            mostrarPaso(pasoActual);

            // Botón Siguiente paso 1
            document.querySelector('.boton-siguiente-paso-1').addEventListener('click', function () {
                pasoActual = 2;
                mostrarPaso(pasoActual);
            });

            // Botón Anterior paso 2
            document.querySelector('.boton-anterior-paso-2').addEventListener('click', function () {
                pasoActual = 1;
                mostrarPaso(pasoActual);
            });

            // Botón Siguiente paso 2
            document.querySelector('.boton-siguiente-paso-2').addEventListener('click', function () {
                pasoActual = 3;
                mostrarPaso(pasoActual);
            });

            // Botón Anterior paso 3
            document.querySelector('.boton-anterior-paso-3').addEventListener('click', function () {
                pasoActual = 2;
                mostrarPaso(pasoActual);
            });

            //Función para validar paso 1

            //Función para validar el paso 2

            //Función para mostrar el mensaje de error



        })
    </script>

</body>
</html>
