<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Paciente</title>
    <link rel="stylesheet" href="/public/css/pacientes.css">
    <%- include('../commons/head') %>
</head>

<body>
    <div class="contenedor-flex contenedor-registro-pacientes">

        <div class="contenedor-logo-lateral">
            <div class="texto-bienvenida">
                <div class="logo"></div>
            </div>
            

            <svg id="fondoWave" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="#005b6f" fill-opacity="1" d="M0,224L60,202.7C120,181,240,139,360,101.3C480,64,600,32,720,58.7C840,85,960,171,1080,181.3C1200,192,1320,128,1380,96L1440,64L1440,320L1380,320C1320,320,1200,320,1080,320C960,320,840,320,720,320C600,320,480,320,360,320C240,320,120,320,60,320L0,320Z"></path></svg>
        </div>

        
        <!-- PASO 1: INFORMACIÓN PERSONAL -->
        <div class="container-pasoUno">

            <div class="proceso-agregar-paciente">
                <h1 style="text-align: center;">Registrarse</h1>

                    <!-- Diagrama de Proceso -->
                    <div class="diagrama-proceso">
                        <div class="paso" id="paso1">
                            <div class="circulo circulo-activo" id="circulo-paso1">1</div>
                            <span>Información Personal</span>
                        </div>
                        <div class="paso" id="paso2">
                            <div class="circulo" id="circulo-paso2">2</div>
                            <span>Información Médica</span>
                        </div>
                        <div class="paso" id="paso3">
                            <div class="circulo" id="circulo-paso3">3</div>
                            <span>Revisión</span>
                        </div>
                    </div>

                    <!-- datos del cliente -->
                    <div class="formulario-proceso">

                        <div class="row">
                            <div class="form-group col-md-6">
                                <!-- Input oculto para capturar el id_usuario -->
                                <!-- <input type="hidden" name="id_usuario" id="idUsuario" value="<%= // idUsuario || '' %>"> -->
                            </div>
                        </div>

                        <div class="row">
                            <div class="form-group col-md-6">
                                <label for="nombre">Nombre</label>
                                <input type="text" name="nombre">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="apellido">Apellido</label>
                                <input type="text" name="apellido">
                            </div>
                        </div>

                        <div class="row">
                            <div class="form-group col-md-6">
                                <label for="dni">DNI</label>
                                <input type="text" name="dni">
                            </div>

                            <div class="form-group col-md-6">
                                <label for="genero">Género</label>
                                <select name="genero" id="genero">
                                    <option value="femenino">Femenino</option>
                                    <option value="masculino">Masculino</option>
                                    <option value="otro">Otro</option>
                                </select>
                            </div>
                            
                        </div>

                        <div class="row">
                            <div class="form-group col-md-6">
                                <label for="fecha_nacimiento">Fecha de nacimiento</label>
                                <input type="date" name="fecha_nacimiento">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="direccion">Dirección</label>
                                <input type="text" name="direccion">
                            </div>
                        </div>
            
                        <div class="row">
                            <div class="form-group col-md-6">
                                <label for="telefono">Teléfono</label>
                                <input type="text" name="telefono">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="email">Email</label>
                                <input type="email" name="email">
                            </div>
                        </div>

                    </div>
                

                    <button class="boton-siguiente boton-siguiente-paso-1 btn">
                        Siguiente
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>

            </div>
        
        </div>

        <!-- PASO 2: INFORMACIÓN MÉDICA -->
        <div class="container-pasoDos ocultar">

            <div class="proceso-agregar-paciente">

                <h1 style="text-align: center;">Agregar Paciente</h1>

                <div class="columna-izquierda">
                    <div class="logo"></div>

                    <!-- Diagrama de Proceso -->
                    <div class="diagrama-proceso">
                        <div class="paso" id="paso1">
                            <div class="circulo circulo-activo" id="circulo-paso1">1</div>
                            <span>Información Personal</span>
                        </div>
                        <div class="paso" id="paso2">
                            <div class="circulo circulo-activo" id="circulo-paso2">2</div>
                            <span>Información Médica</span>
                        </div>
                        <div class="paso" id="paso3">
                            <div class="circulo" id="circulo-paso3">3</div>
                            <span>Revisión</span>
                        </div>
                    </div>


                    <div class="formulario-proceso">

                        <div class="row">
                            <div class="form-group col-md-6">
                                <label for="cobertura">Cobertura</label>
                                <select name="cobertura" id="cobertura">
                                    <% obrasSociales.forEach(obras => { %>
                                        <option value="<%= obras.id %>"><%= obras.nombre %></option>
                                    <% }); %>
                                </select>

                            </div>
                            <div class="form-group col-md-6">
                                <label for="nro_afiliado">Nro. Afiliado</label>
                                <input type="text" name="nro_afiliado" id="">
                            </div>
                        </div>

                    </div>
                
                    <button class="boton-anterior boton-anterior-paso-2 btn">Anterior</button>
                    <button class="boton-siguiente boton-siguiente-paso-2 btn">
                        Siguiente
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>

                </div>
                
            </div>

        
        </div>

        <!-- PASO 3: CONTRAEÑA -->
        <div class="container-pasoTres ocultar">
            <div class="proceso-agregar-paciente">
                <h1 style="text-align: center;">Crear Contraseña</h1>

                <div class="columna-izquierda">
                    <div class="logo"></div>

                    <!-- Diagrama de Proceso -->
                    <div class="diagrama-proceso">
                        <div class="paso" id="paso1">
                            <div class="circulo circulo-activo" id="circulo-paso1">1</div>
                            <span>Información Personal</span>
                        </div>
                        <div class="paso" id="paso2">
                            <div class="circulo circulo-activo" id="circulo-paso2">2</div>
                            <span>Información Médica</span>
                        </div>
                        <div class="paso" id="paso3">
                            <div class="circulo circulo-activo" id="circulo-paso3">3</div>
                            <span>Contraseña</span>
                        </div>
                    </div>

                    <div class="formulario-proceso">
                        <div class="row">
                            <div class="form-group col-md-6">
                                <label for="password">Contraseña</label>
                                <input type="password" name="password" id="password">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="confirmar_password">Confirmar Contraseña</label>
                                <input type="password" name="confirmar_password" id="confirmar_password">
                            </div>
                        </div>

                        <div class="botones">
                            <button class="boton-anterior boton-anterior-paso-3 btn">Anterior</button>
                            <button class="boton-confirmar btn">Guardar Paciente</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            
            // --- VARIABLES DE NAVEGACIÓN ---
            let pasoActual = 1;
            const contenedores = [
                document.querySelector('.container-pasoUno'),
                document.querySelector('.container-pasoDos'),
                document.querySelector('.container-pasoTres')
            ];

            // --- FUNCIONES AUXILIARES ---

            // Función para validar formato de email
            function esEmailValido(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            }

            // Función para mostrar errores
            function mostrarError(mensaje) {
                Swal.fire({
                    title: 'Faltan datos',
                    text: mensaje,
                    icon: 'warning',
                    confirmButtonColor: '#005b6f'
                });
            }

            // Función para cambiar de paso visualmente
            function cambiarPaso(pasoDestino) {
                pasoActual = pasoDestino;
                // Ocultar todos y mostrar el actual
                contenedores.forEach((div, index) => {
                    div.style.display = (index + 1 === pasoActual) ? 'block' : 'none';
                });
                
                // Actualizar círculos del diagrama (opcional, visual)
                for(let i=1; i<=3; i++) {
                    const circulo = document.getElementById(`circulo-paso${i}`);
                    if(i <= pasoActual) circulo.classList.add('circulo-activo'); 
                    // Nota: Asegúrate de tener CSS para .circulo-activo si quieres que se mantengan pintados
                }
            }

            // --- LÓGICA PASO 1: INFORMACIÓN PERSONAL ---
            document.querySelector(".boton-siguiente-paso-1").addEventListener("click", async () => {
                // 1. Capturar datos
                const nombre = document.querySelector("[name=nombre]").value.trim();
                const apellido = document.querySelector("[name=apellido]").value.trim();
                const dni = document.querySelector("[name=dni]").value.trim();
                const fecha_nacimiento = document.querySelector("[name=fecha_nacimiento]").value;
                const genero = document.querySelector("[name=genero]").value;
                const direccion = document.querySelector("[name=direccion]").value.trim();
                const telefono = document.querySelector("[name=telefono]").value.trim();
                const email = document.querySelector("[name=email]").value.trim();

                // 2. VALIDACIONES
                if (!nombre || !apellido) return mostrarError("Por favor, ingresa nombre y apellido.");
                if (!dni || dni.length < 7 || isNaN(dni)) return mostrarError("Ingresa un DNI válido (solo números).");
                if (!fecha_nacimiento) return mostrarError("Debes seleccionar tu fecha de nacimiento.");
                
                // Validar que no sea una fecha futura
                if (new Date(fecha_nacimiento) > new Date()) return mostrarError("La fecha de nacimiento no puede ser futura.");
                
                if (!direccion) return mostrarError("La dirección es obligatoria.");
                if (!telefono || telefono.length < 8) return mostrarError("Ingresa un teléfono válido.");
                if (!email || !esEmailValido(email)) return mostrarError("El formato del correo electrónico no es válido.");

                // 3. Guardar en Session y Backend (Solo si pasa validaciones)
                const nombre_apellido = `${nombre} ${apellido}`;
                sessionStorage.setItem("nombre", nombre_apellido);
                sessionStorage.setItem("dni", dni);
                sessionStorage.setItem("fecha_nacimiento", fecha_nacimiento);
                sessionStorage.setItem("genero", genero);
                sessionStorage.setItem("direccion", direccion);
                sessionStorage.setItem("telefono", telefono);
                sessionStorage.setItem("email", email);

                try {
                    await fetch("/pacientes/guardar-info-personal", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ nombre_apellido, dni, fecha_nacimiento, genero, direccion, telefono, email})
                    });
                    
                    // 4. Avanzar
                    cambiarPaso(2);

                } catch (error) {
                    console.error(error);
                    mostrarError("Error de conexión al guardar datos temporales.");
                }
            });

            // --- LÓGICA PASO 2: INFORMACIÓN MÉDICA ---
            document.querySelector(".boton-siguiente-paso-2").addEventListener("click", async () => {
                // 1. Capturar
                const cobertura = document.querySelector("[name=cobertura]").value;
                const nro_afiliado = document.querySelector("[name=nro_afiliado]").value.trim();

                // 2. VALIDACIONES
                if (!cobertura) return mostrarError("Seleccione una obra social.");
                // Si la obra social requiere número, validarlo:
                if (!nro_afiliado) return mostrarError("El número de afiliado es obligatorio.");

                // 3. Guardar
                sessionStorage.setItem("cobertura", cobertura);
                sessionStorage.setItem("nro_afiliado", nro_afiliado);

                try {
                    await fetch("/pacientes/guardar-info-medica", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ cobertura, nro_afiliado})
                    });

                    // Cargar Resumen Visualmente
                    cargarResumenDesdeStorage(); 
                    
                    // 4. Avanzar
                    cambiarPaso(3);

                } catch (error) {
                    console.error(error);
                    mostrarError("Error al guardar información médica.");
                }
            });

            // Botón Anterior Paso 2
            document.querySelector('.boton-anterior-paso-2').addEventListener('click', () => cambiarPaso(1));


            // --- LÓGICA PASO 3: RESUMEN Y PASSWORD ---
            
            function cargarResumenDesdeStorage(){
                // (Misma lógica que tenías, está correcta para visualización)
                const nombre_apellido = sessionStorage.getItem("nombre") || "-";
                const dni = sessionStorage.getItem("dni") || "-";
                // ... resto de variables ...
                
                // Lógica de nombre de obra social
                let nombreCobertura = "No especificado";
                const idCobertura = sessionStorage.getItem("cobertura");
                const option = document.querySelector(`#cobertura option[value="${idCobertura}"]`);
                if(option) nombreCobertura = option.textContent;

            }

            // Botón Anterior Paso 3
            document.querySelector('.boton-anterior-paso-3').addEventListener('click', () => cambiarPaso(2));

            // CONFIRMACIÓN FINAL
            document.querySelector(".boton-confirmar").addEventListener("click", async () => {
                const password = document.querySelector("#password").value;
                const confirmarPassword = document.querySelector("#confirmar_password").value;

                // VALIDACIONES PASO 3
                if (!password || password.length < 6) return mostrarError("La contraseña debe tener al menos 6 caracteres.");
                if (password !== confirmarPassword) return Swal.fire('Error', 'Las contraseñas no coinciden', 'error');

                // Recopilar todo
                const payload = {
                    nombre_apellido: sessionStorage.getItem("nombre"),
                    dni: sessionStorage.getItem("dni"),
                    fecha_nacimiento: sessionStorage.getItem("fecha_nacimiento"),
                    genero: sessionStorage.getItem("genero"),
                    direccion: sessionStorage.getItem("direccion"),
                    email: sessionStorage.getItem("email"),
                    telefono: sessionStorage.getItem("telefono"),
                    cobertura: sessionStorage.getItem("cobertura"),
                    nro_afiliado: sessionStorage.getItem("nro_afiliado"),
                    password: password
                };

                // Enviar
                try {
                    const response = await fetch("/pacientes/agregar/0", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (result.error === 0) {
                        Swal.fire({
                            title: '¡Registrado!',
                            text: 'Paciente guardado correctamente.',
                            icon: 'success',
                            confirmButtonColor: '#005b6f'
                        }).then(() => {
                            // Limpiar sesión y redirigir
                            sessionStorage.clear();
                            window.location.href = "/loginPacientes"; // O donde corresponda
                        });
                    } else {
                        Swal.fire('Error', result.message || 'No se pudo guardar.', 'error');
                    }
                } catch (error) {
                    console.error(error);
                    Swal.fire('Error', 'Error inesperado de conexión.', 'error');
                }
            });

            // Inicialización
            cambiarPaso(1);
        });
    </script>
    </script>

</body>
</html>
