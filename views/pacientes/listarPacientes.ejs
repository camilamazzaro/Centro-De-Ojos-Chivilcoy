<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pacientes</title>
    <link rel="stylesheet" href="/public/css/pacientes.css">
    <%- include('../commons/head') %>
</head>
<body>
    <div class="contenedor-flex">

        <div class="contenedor-barra-lateral">
            <%- include('../commons/barra-lateral-admin') %>
        </div>

        <div class="contenedor-pacientes">
            <h1>Listado de pacientes</h1>

            <div class="barra-superior-pacientes">

                <!-- Barra de búsqueda -->
                <div class="search-bar">
                    <form id="buscador" class="buscador" action="/pacientes" method="GET">
                        <input type="text" id="search" name="buscador" placeholder="Buscar por nombre, apellido o DNI" value="<%= currentFilters.buscador %>" />
                        <input type="hidden" name="page" value="<%= currentPage %>">
                        <i class="fa-regular fa-magnifying-glass buscador-icono"></i>
                    </form>
                </div>

                <!-- Agregar paciente -->
                <a href="/pacientes/agregar/0" class="btn" target="_blank">
                    <i class="fa-solid fa-plus"></i>
                    Nuevo paciente</a>
            </div>

            <!-- Listado pacientes -->
            <table class="tabla-listado-pacientes">
                <thead>
                    <tr>
                        <th>Paciente</th>
                        <th>Cobertura</th>
                        <th>Contacto</th>
                        <th>Acciones</th>
                    </tr>
                </thead>

                <tbody>
                    <% pacientes.forEach(paciente => { %>
                        <tr data-id="<%= paciente.id %>">

                            <td>
                                <button class="info-paciente btnEditarPaciente"
                                    data-id="<%= paciente.id %>"
                                    data-nombre="<%= paciente.nombre %>"
                                    data-dni="<%= paciente.dni %>"
                                    data-fecha-nacimiento="<%= paciente.fecha_nacimiento %>"
                                    data-genero="<%= paciente.genero %>"
                                    data-direccion="<%= paciente.direccion %>"
                                    data-telefono="<%= paciente.telefono %>"
                                    data-email="<%= paciente.email %>"
                                    data-cobertura="<%= paciente.obra_social %>"
                                    data-nro-afiliado="<%= paciente.nro_afiliado %>">
                                    <%= paciente.nombre %>
                                </button> <br>
                                <%= paciente.dni %>
                            </td>

                            <td>
                                <span class="paciente-cobertura"><%= paciente.obra_social %></span> <br>
                                <%= paciente.nro_afiliado %>
                            </td>

                            <td>
                                <a href="" class="paciente-telefono">
                                    <i class="fa-brands fa-whatsapp"></i>
                                    <%= paciente.telefono %>
                                </a>
                            </td>

                            <td class="paciente-acciones">
                                <a href="/paciente/historias-clinicas/<%= paciente.id %>">HCE</a>
                                <button id="btnAbrirModalReceta" data-id="<%= paciente.id %>">Receta</button>
                                <button>Turno</button>
                            </td>

                        </tr>
                    <% }) %>
                </tbody>
            </table>

            <!-- Paginación -->

            <div class="pagination-container">
                <div class="pagination">
                    <% if (currentPage > 1) { %>
                        <a href="?page=<%= currentPage - 1 %>&limit=<%= limit %>&buscador=<%= currentFilters.buscador %>" class="page-link anterior">Anterior</a>
                    <% } %>
                
                    <!-- Páginas iniciales -->
                    <% if (currentPage > 2) { %>
                        <a href="?page=1&limit=<%= limit %>&buscador=<%= currentFilters.buscador %>" class="page-link">1</a>
                        <% if (currentPage > 3) { %>
                            <span>...</span>
                        <% } %>
                    <% } %>
                
                    <!-- Páginas cercanas a la actual -->
                    <% for (let i = Math.max(1, currentPage - 1); i <= Math.min(totalPages, currentPage + 1); i++) { %>
                        <% if (i === currentPage) { %>
                            <span class="current-page"><%= i %></span>
                        <% } else { %>
                            <a href="?page=<%= i %>&limit=<%= limit %>&buscador=<%= currentFilters.buscador %>" class="page-link"><%= i %></a>
                        <% } %>
                        <% } %>
                
                    <!-- Páginas finales -->
                    <% if (currentPage < totalPages - 1) { %>
                        <% if (currentPage < totalPages - 2) { %>
                            <span>...</span>
                        <% } %>
                        <a href="?page=<%= totalPages %>&limit=<%= limit %>&buscador=<%= currentFilters.buscador %>" class="page-link"><%= totalPages %></a>
                    <% } %>
                
                    <% if (currentPage < totalPages) { %>
                        <a href="?page=<%= currentPage + 1 %>&limit=<%= limit %>&buscador=<%= currentFilters.buscador %>" class="page-link siguiente">Siguiente</a>
                    <% } %>
                </div>

                <form method="GET" action="/pacientes" class="d-flex mb-4 cantidad-paginas align-items-center">
                    <!-- Etiqueta informativa -->
                    <label for="limit" class="me-2">Filas por página:</label>
                        
                    <!-- Seleccionar el límite de registros por página -->
                    <select name="limit" id="limit" onchange="this.form.submit()" class="form-select w-auto" aria-label="Cantidad de registros por página">
                        <option value="5" <%= limit == 5 ? 'selected' : '' %>>5</option>
                        <option value="10" <%= limit == 10 ? 'selected' : '' %>>10</option>
                        <option value="15" <%= limit == 15 ? 'selected' : '' %>>15</option>
                        <option value="20" <%= limit == 20 ? 'selected' : '' %>>20</option>
                    </select>
                </form>  
            </div>


        </div>
    </div>

    <!-- MODAL DETALLES PACIENTE -->
    <%- include('./detallesPaciente') %>

    <div id="modalReceta" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Receta Digital</h2>
                <button class="cerrar-modal-receta cerrar-modal">&times;</button>
            </div>

            <form id="formReceta">
                <input type="hidden" id="idPacienteReceta" name="id_paciente"> <!-- Para saber a qué paciente pertenece la receta a crear -->
                <!-- Selección de médico -->
                <div class="form-group">
                    <label for="medico">Médico</label>
                    <select id="medico" name="medico" required>
                        <option value="">Seleccione un médico</option>
                        <% medicos.forEach(m => { %>
                            <option value="<%= m.id %>"><%= m.nombre %></option>
                        <% }) %>
                    </select>
                </div>

                <!-- Detalles del médico -->
                <div id="detallesMedico" class="sombra" style="display: none;"> 
                    <p><strong>Especialidad</strong> <span id="especialidadMedico">Médico Oftalmólogo</span></p>
                    <p><strong>Matrícula Provincial</strong> <span id="matriculaMedico"></span></p>
                    <p><strong>Dirección</strong> <span id="direccionMedico">Av. Sarmiento 171, Chivilcoy, Bs. As.</span></p> <!--Preguntar-->
                </div>

                <!-- Datos del paciente -->


                <div class="receta-datos-paciente sombra">
                    <p><strong>Paciente</strong> <span id="nombrePaciente"></span></p>
                    <p><strong>DNI</strong> <span id="dniPaciente"></span></p>
                    <p><strong>Cobertura</strong> <span id="coberturaPaciente"></span></p>
                    <p><strong>Nro. Afiliado</strong> <span id="afiliadoPaciente"></span></p>
                </div>
                

                <!-- Datos de receta -->

                <div class="form-group">
                    <label for="fecha">Fecha</label>
                    <input type="date" id="fecha" name="fecha" required>
                </div>

                <div class="form-group">
                    <label for="tratamiento">Tratamiento</label>
                    <textarea id="tratamiento" name="tratamiento" required></textarea>
                </div>

                <div class="form-group">
                    <label for="diagnostico">Diagnóstico (opcional)</label>
                    <textarea id="diagnostico" name="diagnostico"></textarea>
                </div>

                <div class="form-group">
                    <label for="indicaciones">Indicaciones (opcional)</label>
                    <textarea id="indicaciones" name="indicaciones"></textarea>
                </div>

                <div class="form-group">
                    <label for="comentarios">Comentarios (opcional)</label>
                    <textarea id="comentarios" name="comentarios"></textarea>
                </div>

                <!-- Opciones -->
                <div class="receta-firma">
                    <label class="label-opciones">Opciones de firma:</label>
                    <div class="opciones">
                        <label>
                            <input type="checkbox" name="firma_manuscrita" id="checkFirmaManuscrita"> 
                            Firma manuscrita 
                            <span id="estadoFirmaManuscrita" class="badge bg-secondary" style="font-size: 0.7em; margin-left: 5px; color: grey;">Sin archivo</span>
                        </label>
                        
                        <label>
                            <input type="checkbox" name="firma_digital" id="checkFirmaDigital"> 
                            Adjuntar firma digital (opcional)
                            <span id="estadoFirmaDigital" class="badge bg-secondary" style="font-size: 0.7em; margin-left: 5px; color: grey;">Sin archivo</span>
                        </label>
                    </div>
                </div>

                <div class="receta-copias">
                    <label class="label-opciones">Copias:</label>
                    <div class="opciones">
                        <label><input type="radio" name="copias" value="sin" checked> Sin copia</label>
                        <label><input type="radio" name="copias" value="duplicado"> Duplicado</label>
                        <label><input type="radio" name="copias" value="triplicado"> Triplicado</label>
                    </div>
                </div>

                <div class="receta-pdf">
                    <label class="label-opciones">Tamaño de PDF:</label>
                    <div class="opciones">
                        <label><input type="radio" name="formato_pdf" value="A4" checked> A4</label>
                        <label><input type="radio" name="formato_pdf" value="A5"> A5</label>
                    </div>
                </div>


                <button type="submit" class="btn">Generar Receta</button>
            </form>
        </div>
    </div>

    <%- include('../historias_clinicas/modalesRecetas') %>

    <script>

        document.addEventListener("DOMContentLoaded", () => {
            const modalReceta = document.getElementById("modalReceta");
            const cerrarModalReceta = document.querySelector(".cerrar-modal-receta");

            const botonesReceta = document.querySelectorAll("#btnAbrirModalReceta");
            botonesReceta.forEach(btn => {
                btn.addEventListener("click", () => {
                    const tr = btn.closest("tr");
                    
                    // Llenar datos visuales (spans)
                    document.getElementById("nombrePaciente").textContent = tr.querySelector("button").dataset.nombre;
                    document.getElementById("dniPaciente").textContent = tr.querySelector("button").dataset.dni;
                    document.getElementById("coberturaPaciente").textContent = tr.querySelector("button").dataset.cobertura;
                    document.getElementById("afiliadoPaciente").textContent = tr.querySelector("button").dataset.nroAfiliado;

                    const idPaciente = btn.dataset.id; 
                    document.getElementById("idPacienteReceta").value = idPaciente; 

                    document.getElementById("modalReceta").style.display = "flex";
                });
            });

            cerrarModalReceta.addEventListener("click", () => {
                modalReceta.style.display = "none";
            });
        });

        
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const medicos = <%- JSON.stringify(medicos) %>;

            const medicoSelect = document.getElementById('medico');
            const detallesMedico = document.getElementById('detallesMedico');
            const matricula = document.getElementById('matriculaMedico');

            medicoSelect.addEventListener('change', () => {
                const medicoId = parseInt(medicoSelect.value);
                const medico = medicos.find(m => m.id === medicoId);

                if (medico) {
                    matricula.textContent = medico.matricula;
                    detallesMedico.style.display = 'flex';
                } else {
                    detallesMedico.style.display = 'none';
                }
            });

            // Si vas a llenar el paciente con JS (por ejemplo, al hacer clic en un botón de receta)
            const botonesReceta = document.querySelectorAll("#btnAbrirModalReceta");
            botonesReceta.forEach(btn => {
                btn.addEventListener("click", () => {
                    const tr = btn.closest("tr");

                    document.getElementById("nombrePaciente").textContent = tr.querySelector("button").dataset.nombre;
                    document.getElementById("dniPaciente").textContent = tr.querySelector("button").dataset.dni;
                    document.getElementById("coberturaPaciente").textContent = tr.querySelector("button").dataset.cobertura;
                    document.getElementById("afiliadoPaciente").textContent = tr.querySelector("button").dataset.nroAfiliado;

                    document.getElementById("modalReceta").style.display = "flex";
                });
            });

            document.querySelector(".cerrar-modal-receta").addEventListener("click", () => {
                document.getElementById("modalReceta").style.display = "none";
            });
        });

        // MODAL DE CARGA DE FIRMA - RECETA

        const modalArchivo = document.getElementById('modalSubirArchivo');
        const inputArchivo = document.getElementById('inputArchivoFirma');
        const btnConfirmarArchivo = document.getElementById('btnConfirmarArchivo');
        const btnCerrarArchivo = document.querySelector('.cerrar-modal-archivo');
        const tituloModalArchivo = document.getElementById('tituloModalArchivo');

        const checkManuscrita = document.getElementById('checkFirmaManuscrita');
        const checkDigital = document.getElementById('checkFirmaDigital');
        const badgeManuscrita = document.getElementById('estadoFirmaManuscrita');
        const badgeDigital = document.getElementById('estadoFirmaDigital');

        let archivoManuscritaTemp = null;
        let archivoDigitalTemp = null;
        let tipoFirmaActual = '';

        function abrirModalCarga(tipo) {
            tipoFirmaActual = tipo;
            tituloModalArchivo.textContent = tipo === 'manuscrita' ? 'Adjuntar Firma Manuscrita' : 'Adjuntar Firma Digital';
            inputArchivo.value = ''; // Limpiar input
            modalArchivo.style.display = 'flex';
        }

        function actualizarBadges() {
            if(badgeManuscrita) {
                badgeManuscrita.textContent = archivoManuscritaTemp ? 'Archivo cargado' : 'Sin archivo';
                badgeManuscrita.style.color = archivoManuscritaTemp ? 'green' : 'grey';
            }
            if(badgeDigital) {
                badgeDigital.textContent = archivoDigitalTemp ? 'Archivo cargado' : 'Sin archivo';
                badgeDigital.style.color = archivoDigitalTemp ? 'green' : 'grey';
            }
        }

        // Listeners Checkboxes
        checkManuscrita.addEventListener('change', (e) => {
            if(e.target.checked) {
                abrirModalCarga('manuscrita');
            } else {
                archivoManuscritaTemp = null;
                actualizarBadges();
            }
        });

        checkDigital.addEventListener('change', (e) => {
            if(e.target.checked) {
                abrirModalCarga('digital');
            } else {
                archivoDigitalTemp = null;
                actualizarBadges();
            }
        });

        // Confirmar Archivo del Modal Secundario
        btnConfirmarArchivo.addEventListener('click', () => {
            if (inputArchivo.files.length > 0) {
                const archivo = inputArchivo.files[0];
                if (tipoFirmaActual === 'manuscrita') {
                    archivoManuscritaTemp = archivo;
                } else {
                    archivoDigitalTemp = archivo;
                }
                actualizarBadges();
                modalArchivo.style.display = 'none';
            } else {
                alert("Por favor seleccione un archivo.");
            }
        });

        btnCerrarArchivo.addEventListener('click', () => {
            modalArchivo.style.display = 'none';
            // Si cerró sin cargar, desmarcamos el checkbox
            if(tipoFirmaActual === 'manuscrita' && !archivoManuscritaTemp) checkManuscrita.checked = false;
            if(tipoFirmaActual === 'digital' && !archivoDigitalTemp) checkDigital.checked = false;
        });


        // ENVIAR DATOS PARA CREAR RECETA

        const formReceta = document.getElementById('formReceta');
    
        formReceta.addEventListener('submit', async (e) => {
            e.preventDefault(); 

            // Usamos FormData para poder enviar archivos
            const formData = new FormData(formReceta);
            
            // Agregamos manualmente los archivos si existen
            if(archivoManuscritaTemp) formData.append('archivo_manuscrita', archivoManuscritaTemp);
            if(archivoDigitalTemp) formData.append('archivo_digital', archivoDigitalTemp);

            // Aseguramos los valores booleanos de los checkboxes
            formData.set('firma_manuscrita', checkManuscrita.checked);
            formData.set('firma_digital', checkDigital.checked);

            try {
                // NOTA: Al usar FormData, NO se debe poner el header 'Content-Type': 'application/json'
                // El navegador detecta automáticamente 'multipart/form-data'
                const response = await fetch('/pacientes/receta/crear', {
                    method: 'POST',
                    body: formData 
                });

                const result = await response.json();

                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Receta Creada!',
                        text: result.mensaje,
                        confirmButtonText: 'Aceptar'
                    }).then(() => {
                        document.getElementById("modalReceta").style.display = "none";
                        formReceta.reset();
                        // Resetear variables globales
                        archivoManuscritaTemp = null;
                        archivoDigitalTemp = null;
                        actualizarBadges();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: result.mensaje
                    });
                }

            } catch (error) {
                console.error(error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Hubo un problema de conexión.'
                });
            }
        });

        </script>


</body>


</html>