<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Pacientes</title>
    <link rel="stylesheet" href="/public/css/pacientes.css">
    <%- include('../commons/head') %>
</head>

<body>
    <div class="contenedor-login">
        <div class="contenedor-logo-lateral">
            <div class="texto-bienvenida">
                <div class="logo"></div>
            </div>
            

            <svg id="fondoWave" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="#005b6f" fill-opacity="1" d="M0,224L60,202.7C120,181,240,139,360,101.3C480,64,600,32,720,58.7C840,85,960,171,1080,181.3C1200,192,1320,128,1380,96L1440,64L1440,320L1380,320C1320,320,1200,320,1080,320C960,320,840,320,720,320C600,320,480,320,360,320C240,320,120,320,60,320L0,320Z"></path></svg>
        </div>

        <div class="login-box">
            <h1>Ingreso al Panel de Pacientes</h1>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Correo electrónico</label>
                    <div class="input-icono">
                        <i class="fa fa-envelope"></i>
                        <input type="email" name="email" id="email" required placeholder="ejemplo@email.com">
                    </div>
                </div>

                <div class="form-group">
                    <label for="password">Contraseña</label>
                    <input type="password" id="password" name="password" placeholder="Ingresa tu contraseña" minlength="3" required autocomplete="current-password">
                    <i id="togglePassword" class="fas fa-eye-slash" onclick="togglePasswordVisibility()"></i>
                </div>

                <!-- Link para recuperar la contraseña -->
                <div class="contenedor-recuperarPassword">
                    <a href="javascript:void(0);" onclick="mostrarModal()" class="olvidaste-password">¿Olvidaste tu contraseña?</a>
                </div>

                <button type="submit" class="btn btn-primario">Ingresar</button>
                <a href="/registroPacientes" class="btn">Registrarse</a>
            </form>

            <div id="mensaje" style="color: red; margin-top: 10px;"></div>

        </div>
    </div>


    <!--formulario para cambiar contraseña. No lo hice con sweet alert para personalizarle los estilos-->
    <div id="modal-recuperar" class="formulario-recuperar">
        <div class="formulario-recuperar-contenido">
            <span class="close" onclick="cerrarModal()">&times;</span> <!--Para poder apretar una cruz y cerrar el formulario-->
            <h2>Recuperar Contraseña</h2>
            <p>¿Olvidaste tu contraseña? Ingresá tu mail para iniciar el proceso de recuperación.</p>
            <form id="formularioRecuperarContraseña">
                <div class="contenedor-input">
                    <i class="fas fa-envelope icono"></i>
                    <input type="email" id="emailRecuperar" placeholder="Ingrese su email" required>
                </div>
                <button class="solicitar-cambio btn">Solicitar Cambio</button>
            </form>
        </div>
    </div>

    <script>

        // Mostrar y ocultar contraseña
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password');
            const eyeIcon = document.getElementById('togglePassword');
            
            // Si la contraseña está oculta, mostrarla y cambiar el icono
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.classList.remove('fa-eye-slash'); // Ojo tachado
                eyeIcon.classList.add('fa-eye'); // Ojo sin tachar
            } else {
                passwordInput.type = 'password';
                eyeIcon.classList.remove('fa-eye'); // Ojo sin tachar
                eyeIcon.classList.add('fa-eye-slash'); // Ojo tachado
            }
        }

        // Modal de recuperar password
        document.getElementById('emailRecuperar').addEventListener('focus', function() {
            const icono = document.querySelector('.contenedor-input .icono');
            icono.style.opacity = '0'; // Oculta el ícono cuando el campo recibe foco
        });
        
        document.getElementById('emailRecuperar').addEventListener('blur', function() {
            const icono = document.querySelector('.contenedor-input .icono');
            if (this.value === "") {
                icono.style.opacity = '1'; // Muestra el ícono cuando el campo pierde el foco si está vacío
            }
        });
        
        document.getElementById('emailRecuperar').addEventListener('input', function() {
            const icono = document.querySelector('.contenedor-input .icono');
            if (this.value.length > 0) {
                icono.style.opacity = '0'; // Oculta el ícono cuando hay texto
            } else {
                icono.style.opacity = '1'; // Muestra el ícono si el campo está vacío
            }
        });

        // Enviar formulario de recuperar password
        document.querySelector('.solicitar-cambio').addEventListener('click', async (e) => {
            e.preventDefault(); // Para evitar que el formulario se envíe de forma tradicional
        
            const email = document.querySelector('#emailRecuperar').value;

            cerrarModal();

            // Mensaje de espere...
            const esperando = Swal.fire({
                title: 'Espere...',
                text: 'Estamos procesando tu solicitud',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try{
                const resultado = await fetch('/loginPacientes/solicitarCambioPass', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email })
                });
            
                const data = await resultado.json();
            
                if (data.message === "Correo enviado con éxito. Revisa tu bandeja de entrada.") {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Correo enviado!',
                        text: 'Por favor, revisa tu bandeja de entrada para continuar con el cambio de contraseña.',
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: '¡Error!',
                        text: data.message || 'Hubo un problema al intentar enviar el correo.',
                    });
                }
            } catch(err){
                Swal.close();
                Swal.fire({
                    icon: 'error',
                    title: 'Error de conexión',
                    text: 'No se pudo completar la solicitud. Intentalo más tarde.'
                });
            }
        
        });
    </script>

    <script>
        // Enviar login al backend
        const form = document.getElementById('loginForm');
        const mensaje = document.getElementById('mensaje');

        //mostrar el formulario para cambiar contraseña
        function mostrarModal() {
            document.getElementById("modal-recuperar").style.display = "block";
        }
        
        //cerrar formulario de arriba
        function cerrarModal() {
            document.getElementById("modal-recuperar").style.display = "none";
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = form.email.value;
            const password = form.password.value;

            try {
                const response = await fetch('/loginPacientes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (data.error === 0) {
                    // Login exitoso, redirige al panel del paciente
                    window.location.href = '/panelPacientes';
                } else {
                    // Mostrar mensaje de error
                    mensaje.textContent = data.message;
                }

            } catch (err) {
                mensaje.textContent = 'Error de conexión.';
                console.error(err);
            }
        });
    </script>

</body>

</html>
