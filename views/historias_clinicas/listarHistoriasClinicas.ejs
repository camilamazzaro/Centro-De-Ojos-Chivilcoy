<!DOCTYPE html>
<html lang="es">

<head>
    <%- include('../commons/head') %>
    <title>Listado HC paciente</title>
    <link rel="stylesheet" href="/public/css/his_clinicas.css">
</head>


<body>
    <div class="contenedor-flex">

        <div class="contenedor-barra-lateral">
            <%- include('../commons/barra-lateral-admin') %>
        </div>

        <div class="contenedor-listado">

            <% if (historias.id == 0) { %>
                <h1 class="text-center mb-4">Este paciente no posee ninguna historia clínica</h1>
            <% } else { %>

            <div class="container contenedor-historias-clinicas mt-5 contenedor">
                <h1 class="mb-4">Legajo de <%= paciente.nombre %></h1>
        
                <div class="nav-tabs">
                    <button class="nav-link active" onclick="cambiarTab(event, 'historias')">
                        <i class="fa-solid fa-file-medical me-2"></i> Historias Clínicas
                    </button>
                    <button class="nav-link" onclick="cambiarTab(event, 'recetas')">
                        <i class="fa-solid fa-prescription-bottle-medical me-2"></i> Recetas
                    </button>
                </div>

                <div id="historias" class="tab-content">
                    <div class="div-superior">

                        <div class="search-bar d-flex align-items-center gap-2">
                            <form class="buscador d-flex align-items-center" method="GET" action="/paciente/historias-clinicas/<%= paciente.id %>">
                                <input type="date" name="fecha" value="<%= typeof fecha !== 'undefined' ? fecha : '' %>" class="form-control me-2">
                                <button type="submit" class="btn-buscar">
                                    <i class="fa fa-search"></i>
                                </button>
                            </form>

                            <% if (fecha) { %>
                                <a href="/paciente/historias-clinicas/<%= paciente.id %>" class="btn btn-outline-secondary">
                                    <i class="fa fa-times"></i> Borrar
                                </a>
                            <% } %>
                        </div>

                
                        <div class="mb-3">
                            <a class="btn btn-agregar" href="/paciente/<%= paciente.id %>/historia-clinica/agregar">
                                <i class="fa-solid fa-plus"></i>
                                <span>Nueva Historia Clínica</span>
                            </a>
                        </div>
                    </div>

                    <div class="contenedor-his-clinica">
                        <% historias.forEach(h => { %>
                            <article>
                                <div>
                                    <h5><strong>Paciente:</strong> <%= paciente.nombre %> - <strong>Nro. Afiliado:</strong> <%= paciente.nro_afiliado %></h5>
                                    <hr>
                                    <div class="fechaHora">
                                        <% let date = new Date(h.fecha) %>
                                        <div class="fecha">
                                            <i class="fa-regular fa-calendar"></i>
                                            <span><%= date.getDate() %>/<%= date.getMonth()+1 %>/<%= date.getFullYear() %></span>
                                        </div>
                                        <div class="hora">
                                            <i class="fa-regular fa-clock"></i>
                                            <span><%= date.getHours() %>:<%= date.getMinutes() %></span>
                                        </div>
                                    </div>
                                    <p><strong>Motivo de la Consulta</strong><br><%= h.motivo %></p>
                                </div>
                                <a href="/paciente/<%= paciente.id %>/historia-clinica/<%= h.historia_id %>/editar">Ver Detalle</a>
                            </article>
                        <% }); %>
                    </div>


                    <div class="pagination-container">
                    <% if (totalPaginas > 1) { %>
                        <nav class="mt-4 paginador">
                        <ul class="pagination justify-content-center">

                            <% const maxNumeros = 5;
                            let inicio = Math.max(1, pagina - Math.floor(maxNumeros / 2));
                            let fin = inicio + maxNumeros - 1;
                            if (fin > totalPaginas) {
                                fin = totalPaginas;
                                inicio = Math.max(1, fin - maxNumeros + 1);
                            }
                            %>

                            <!-- Flecha anterior -->
                            <li class="page-item <%= pagina === 1 ? 'disabled' : '' %>">
                            <a class="page-link" href="?pagina=<%= pagina - 1 %><%= fecha ? '&fecha=' + fecha : '' %>">
                                &laquo;
                            </a>
                            </li>

                            <!-- Números de página -->
                            <% for (let i = inicio; i <= fin; i++) { %>
                            <li class="page-item <%= i === pagina ? 'active' : '' %>">
                                <a class="page-link" href="?pagina=<%= i %><%= fecha ? '&fecha=' + fecha : '' %>"><%= i %></a>
                            </li>
                            <% } %>

                            <!-- Flecha siguiente -->
                            <li class="page-item <%= pagina === totalPaginas ? 'disabled' : '' %>">
                            <a class="page-link" href="?pagina=<%= pagina + 1 %><%= fecha ? '&fecha=' + fecha : '' %>">
                                &raquo;
                            </a>
                            </li>

                        </ul>
                        </nav>
                    <% } %>
                    </div>
                </div>

                <div id="recetas" class="tab-content" style="display: none;">
        
                    <div class="div-superior">
                        <h3 style="margin: 0; color: #555;">Historial de Recetas</h3>
                        
                        <button class="btn btn-agregar btnAbrirModalReceta" 
                            data-id="<%= paciente.id %>"
                            data-nombre="<%= paciente.nombre %>"
                            data-dni="<%= paciente.dni %>"
                            data-cobertura="<%= paciente.cobertura %>"  data-nro-afiliado="<%= paciente.nro_afiliado %>">
                            <i class="fa-solid fa-plus"></i> Nueva Receta
                        </button>
                    </div>

                    <div class="table-responsive mt-3">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Médico</th>
                                    <th>Tratamiento</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (typeof recetas !== 'undefined' && recetas.length > 0) { %>
                                    <% recetas.forEach(receta => { %>
                                        <tr>
                                            <td><%= new Date(receta.fecha).toLocaleDateString() %></td>
                                            <td><%= receta.nombre_medico %></td>
                                            <td class="col-tratamiento"><%= receta.tratamiento %></td>
                                            <td>
                                                <a href="/receta/ver/<%= receta.id %>" target="_blank" class="btn btn-sm btn-outline-primary" title="Imprimir PDF">
                                                    <i class="fa-solid fa-print"></i>
                                                </a>

                                                <button class="btn btn-sm btn-outline-primary btnEditarReceta" 
                                                    title="Editar Receta"
                                                    data-id="<%= receta.id %>"
                                                    data-fecha="<%= new Date(receta.fecha).toISOString().split('T')[0] %>" 
                                                    data-medico="<%= receta.id_medico %>"
                                                    data-tratamiento="<%= receta.tratamiento %>"
                                                    data-diagnostico="<%= receta.diagnostico %>"
                                                    data-indicaciones="<%= receta.indicaciones %>"
                                                    data-comentarios="<%= receta.comentarios %>"
                                                    data-firma-manuscrita="<%= receta.firma_manuscrita %>"
                                                    data-firma-digital="<%= receta.firma_digital %>"
                                                    data-copias="<%= receta.copias %>"
                                                    data-formato="<%= receta.formato_pdf %>">
                                                    <i class="fa-solid fa-pen-to-square"></i>
                                                </button>

                                                <button class="btn btn-sm btn-outline-danger btnEliminarReceta" 
                                                    title="Eliminar Receta"
                                                    data-id="<%= receta.id %>">
                                                    <i class="fa-solid fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    <% }) %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="4" class="text-center p-4">No hay recetas generadas para este paciente.</td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>

            <% } %>

            

        </div>
    </div>
    
    <div id="modalEditarReceta" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Receta</h2>
                <button class="cerrar-modal-editar cerrar-modal">&times;</button>
            </div>

            <form id="formEditarReceta">
                <input type="hidden" id="edit_id_receta" name="id_receta">

                <div class="form-group">
                    <label for="edit_fecha">Fecha</label>
                    <input type="date" id="edit_fecha" name="fecha" required>
                </div>

                <div class="form-group">
                    <label for="edit_medico">Médico</label>
                    <select id="edit_medico" name="medico" required>
                        <% medicos.forEach(m => { %>
                            <option value="<%= m.id %>"><%= m.nombre %></option>
                        <% }) %>
                    </select>
                </div>

                <div class="form-group">
                    <label for="edit_tratamiento">Tratamiento</label>
                    <textarea id="edit_tratamiento" name="tratamiento" required></textarea>
                </div>

                <div class="form-group">
                    <label for="edit_diagnostico">Diagnóstico</label>
                    <textarea id="edit_diagnostico" name="diagnostico"></textarea>
                </div>

                <div class="form-group">
                    <label for="edit_indicaciones">Indicaciones</label>
                    <textarea id="edit_indicaciones" name="indicaciones"></textarea>
                </div>

                <div class="form-group">
                    <label for="edit_comentarios">Comentarios</label>
                    <textarea id="edit_comentarios" name="comentarios"></textarea>
                </div>

                <div class="receta-firma">
                    <label class="label-opciones">Opciones de firma:</label>
                    <div class="opciones">
                        <label><input type="checkbox" id="edit_firma_manuscrita" name="firma_manuscrita"> Firma manuscrita</label>
                        <label><input type="checkbox" id="edit_firma_digital" name="firma_digital"> Firma digital</label>
                    </div>
                </div>

                <div class="receta-copias">
                    <label class="label-opciones">Copias:</label>
                    <div class="opciones">
                        <label><input type="radio" name="copias" value="sin" id="edit_copia_sin"> Sin copia</label>
                        <label><input type="radio" name="copias" value="duplicado" id="edit_copia_duplicado"> Duplicado</label>
                        <label><input type="radio" name="copias" value="triplicado" id="edit_copia_triplicado"> Triplicado</label>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" style="margin-top: 15px;">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <div id="modalReceta" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Receta Digital</h2>
                <button class="cerrar-modal-receta cerrar-modal">&times;</button>
            </div>

            <form id="formReceta">
                <input type="hidden" id="idPacienteReceta" name="id_paciente"> <!-- Para saber a qué paciente pertenece la receta a crear -->
                <!-- Selección de médico -->
                <div class="form-group">
                    <label for="medico">Médico</label>
                    <select id="medico" name="medico" required>
                        <option value="">Seleccione un médico</option>
                        <% medicos.forEach(m => { %>
                            <option value="<%= m.id %>"><%= m.nombre %></option>
                        <% }) %>
                    </select>
                </div>

                <!-- Detalles del médico -->
                <div id="detallesMedico" class="sombra" style="display: none;"> 
                    <p><strong>Especialidad</strong> <span id="especialidadMedico">Médico Oftalmólogo</span></p>
                    <p><strong>Matrícula Provincial</strong> <span id="matriculaMedico"></span></p>
                    <p><strong>Dirección</strong> <span id="direccionMedico">Av. Sarmiento 171, Chivilcoy, Bs. As.</span></p> <!--Preguntar-->
                </div>

                <!-- Datos del paciente -->


                <div class="receta-datos-paciente sombra">
                    <p><strong>Paciente</strong> <span id="nombrePaciente"></span></p>
                    <p><strong>DNI</strong> <span id="dniPaciente"></span></p>
                    <p><strong>Cobertura</strong> <span id="coberturaPaciente"></span></p>
                    <p><strong>Nro. Afiliado</strong> <span id="afiliadoPaciente"></span></p>
                </div>
                

                <!-- Datos de receta -->

                <div class="form-group">
                    <label for="fecha">Fecha</label>
                    <input type="date" id="fecha" name="fecha" required>
                </div>

                <div class="form-group">
                    <label for="tratamiento">Tratamiento</label>
                    <textarea id="tratamiento" name="tratamiento" required></textarea>
                </div>

                <div class="form-group">
                    <label for="diagnostico">Diagnóstico (opcional)</label>
                    <textarea id="diagnostico" name="diagnostico"></textarea>
                </div>

                <div class="form-group">
                    <label for="indicaciones">Indicaciones (opcional)</label>
                    <textarea id="indicaciones" name="indicaciones"></textarea>
                </div>

                <div class="form-group">
                    <label for="comentarios">Comentarios (opcional)</label>
                    <textarea id="comentarios" name="comentarios"></textarea>
                </div>

                <!-- Opciones -->
                <div class="receta-firma">
                    <label class="label-opciones">Opciones de firma:</label>
                    <div class="opciones">
                        <label><input type="checkbox" name="firma_manuscrita"> Firma manuscrita</label>
                        <label><input type="checkbox" name="firma_digital"> Adjuntar firma digital (opcional)</label>
                    </div>
                </div>

                <div class="receta-copias">
                    <label class="label-opciones">Copias:</label>
                    <div class="opciones">
                        <label><input type="radio" name="copias" value="sin" checked> Sin copia</label>
                        <label><input type="radio" name="copias" value="duplicado"> Duplicado</label>
                        <label><input type="radio" name="copias" value="triplicado"> Triplicado</label>
                    </div>
                </div>

                <div class="receta-pdf">
                    <label class="label-opciones">Tamaño de PDF:</label>
                    <div class="opciones">
                        <label><input type="radio" name="formato_pdf" value="A4" checked> A4</label>
                        <label><input type="radio" name="formato_pdf" value="A5"> A5</label>
                    </div>
                </div>


                <button type="submit" class="btn">Generar Receta</button>
            </form>
        </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    // 1. Lógica para eliminar historias clínicas (Ya estaba ok)
    document.querySelectorAll('.btnEliminar').forEach(button => {
        button.addEventListener('click', async() => {
            const pacienteId = button.getAttribute('data-id');
            if (confirm('¿Estás seguro de que deseas eliminar esta H.C.?')) {
                const response = await fetch(`/historiasclinicas/eliminar/${pacienteId}`, {
                    method: 'DELETE'
                });
                location.reload(); 
            }
        });
    });

    // Función auxiliar
    function quitarAcentos(texto) {
        return texto.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }

    // 2. BUSCADOR DE HISTORIAS CLÍNICAS
    document.addEventListener("input", (e) => {
        if (e.target.matches("#buscador")) {
            const searchTerm = e.target.value.toLowerCase();

            document.querySelectorAll(".contenedor-his-clinica article").forEach((article) => {
                const nombrePaciente = quitarAcentos(article.querySelector("h5").textContent.toLowerCase());
                if (nombrePaciente.includes(searchTerm)) {
                    article.style.display = ""; 
                } else {
                    article.style.display = "none"; 
                }
            });
        }
    }); 

    // Modal Editar receta -------------------------------------------------
    const modalEditar = document.getElementById("modalEditarReceta");
    const btnCerrarEditar = document.querySelector(".cerrar-modal-editar");
    const formEditar = document.getElementById("formEditarReceta");

    // ABRIR MODAL Y CARGAR DATOS
    const botonesEditar = document.querySelectorAll(".btnEditarReceta");
    
    if(botonesEditar.length > 0) {
        botonesEditar.forEach(btn => {
            btn.addEventListener("click", () => {
                // Llenar campos
                document.getElementById("edit_id_receta").value = btn.dataset.id;
                document.getElementById("edit_fecha").value = btn.dataset.fecha;
                document.getElementById("edit_medico").value = btn.dataset.medico;
                document.getElementById("edit_tratamiento").value = btn.dataset.tratamiento;
                document.getElementById("edit_diagnostico").value = btn.dataset.diagnostico;
                document.getElementById("edit_indicaciones").value = btn.dataset.indicaciones;
                document.getElementById("edit_comentarios").value = btn.dataset.comentarios;

                document.getElementById("edit_firma_manuscrita").checked = (btn.dataset.firmaManuscrita == '1');
                document.getElementById("edit_firma_digital").checked = (btn.dataset.firmaDigital == '1');

                // Radios (Copias)
                const copiasVal = btn.dataset.copias; 
                const radioCopia = document.getElementById(`edit_copia_${copiasVal}`);
                if(radioCopia) radioCopia.checked = true;

                // Mostrar Modal
                modalEditar.style.display = "flex";
            });
        });
    }

    if(btnCerrarEditar) {
        btnCerrarEditar.addEventListener("click", () => {
            modalEditar.style.display = "none";
        });
    }

    if(formEditar) {
        formEditar.addEventListener("submit", async (e) => {
            e.preventDefault();
            
            const formData = new FormData(formEditar);
            const data = Object.fromEntries(formData.entries());

            // Ajuste manual para checkboxes
            data.firma_manuscrita = document.getElementById("edit_firma_manuscrita").checked;
            data.firma_digital = document.getElementById("edit_firma_digital").checked;

            try {
                const response = await fetch('/pacientes/receta/editar', {
                    method: 'PUT', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    Swal.fire('Actualizado', 'La receta se modificó correctamente', 'success')
                        .then(() => location.reload());
                } else {
                    Swal.fire('Error', result.mensaje, 'error');
                }
            } catch (error) {
                console.error(error);
                Swal.fire('Error', 'Fallo de conexión', 'error');
            }
        });
    }


    // ELIMINAR RECETA
    const botonesEliminarReceta = document.querySelectorAll(".btnEliminarReceta");

    if (botonesEliminarReceta.length > 0) {
        botonesEliminarReceta.forEach(btn => {
            btn.addEventListener("click", () => {
                const idReceta = btn.dataset.id;

                Swal.fire({
                    title: '¿Eliminar receta?',
                    text: "Esta acción no se puede deshacer.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        try {
                            const response = await fetch(`/pacientes/receta/eliminar/${idReceta}`, {
                                method: 'DELETE'
                            });
                            
                            const data = await response.json();

                            if (data.success) {
                                Swal.fire(
                                    '¡Eliminado!',
                                    'La receta ha sido eliminada.',
                                    'success'
                                ).then(() => {
                                    location.reload(); 
                                });
                            } else {
                                Swal.fire('Error', data.mensaje, 'error');
                            }
                        } catch (error) {
                            console.error(error);
                            Swal.fire('Error', 'No se pudo conectar con el servidor', 'error');
                        }
                    }
                });
            });
        });
    }



</script>

    <script>
        function cambiarTab(evt, tabName) {
            localStorage.setItem('activeTab', tabName);

            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            tablinks = document.getElementsByClassName("nav-link");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }

            document.getElementById(tabName).style.display = "block";
            
            if (evt) {
                evt.currentTarget.className += " active";
            } else {
                const btn = document.querySelector(`button[onclick*="'${tabName}'"]`);
                if(btn) btn.className += " active";
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
        const lastTab = localStorage.getItem('activeTab') || 'historias';
        
        cambiarTab(null, lastTab);
    });
    </script>

    <script>
        // MODAL DE "NUEVA RECETA"
        const btnNuevaReceta = document.querySelector("#recetas .btnAbrirModalReceta");
        const modalNuevaReceta = document.getElementById("modalReceta");
        
        if (btnNuevaReceta) {
            btnNuevaReceta.addEventListener("click", () => {
                document.getElementById("nombrePaciente").textContent = btnNuevaReceta.dataset.nombre;
                document.getElementById("dniPaciente").textContent = btnNuevaReceta.dataset.dni;
                document.getElementById("coberturaPaciente").textContent = btnNuevaReceta.dataset.cobertura;
                document.getElementById("afiliadoPaciente").textContent = btnNuevaReceta.dataset.nroAfiliado;

                document.getElementById("idPacienteReceta").value = btnNuevaReceta.dataset.id;

                modalNuevaReceta.style.display = "flex";
            });
        }

        const cerrarModalNueva = document.querySelector(".cerrar-modal-receta");
        if(cerrarModalNueva){
            cerrarModalNueva.addEventListener("click", () => {
                modalNuevaReceta.style.display = "none";
            });
        }

        // ENVIAR DATOS PARA CREAR RECETA
        
        const formReceta = document.getElementById('formReceta');
    
        formReceta.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(formReceta);
            const datos = Object.fromEntries(formData.entries());
            
            datos.firma_manuscrita = formReceta.querySelector('[name="firma_manuscrita"]').checked;
            datos.firma_digital = formReceta.querySelector('[name="firma_digital"]').checked;

            try {
                const response = await fetch('/pacientes/receta/crear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(datos)
                });

                const result = await response.json();

                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Receta Creada!',
                        text: result.mensaje,
                        confirmButtonText: 'Aceptar'
                    }).then(() => {
                        document.getElementById("modalReceta").style.display = "none";
                        formReceta.reset(); 
                        
                        location.reload(); 
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: result.mensaje
                    });
                }

            } catch (error) {
                console.error(error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Hubo un problema de conexión.'
                });
            }
        });
    </script>
</body>
</html>