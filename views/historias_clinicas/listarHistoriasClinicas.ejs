<!DOCTYPE html>
<html lang="es">

<head>
    <%- include('../commons/head') %>
    <title>Listado HC paciente</title>
    <link rel="stylesheet" href="/public/css/his_clinicas.css">
</head>


<body>
    <div class="contenedor-flex">

        <div class="contenedor-barra-lateral">
            <%- include('../commons/barra-lateral-admin') %>
        </div>

        <div class="contenedor-listado">

            <% if (historias.id == 0) { %>
                <h1 class="text-center mb-4">Este paciente no posee ninguna historia clínica</h1>
            <% } else { %>

            <div class="container contenedor-historias-clinicas mt-5 contenedor">
                <h1 class="mb-4">Legajo de <%= paciente.nombre %></h1>
        
                <div class="nav-tabs">
                    <button class="nav-link active" onclick="cambiarTab(event, 'historias')">
                        <i class="fa-solid fa-file-medical me-2"></i> Historias Clínicas
                    </button>
                    <button class="nav-link" onclick="cambiarTab(event, 'recetas')">
                        <i class="fa-solid fa-prescription-bottle-medical me-2"></i> Recetas
                    </button>
                </div>

                <div id="historias" class="tab-content">
                    <div class="div-superior">

                        <div class="search-bar d-flex align-items-center gap-2">
                            <form class="buscador d-flex align-items-center" method="GET" action="/paciente/historias-clinicas/<%= paciente.id %>">
                                <input type="date" name="fecha" value="<%= typeof fecha !== 'undefined' ? fecha : '' %>" class="form-control me-2">
                                <button type="submit" class="btn-buscar">
                                    <i class="fa fa-search"></i>
                                </button>
                            </form>

                            <% if (fecha) { %>
                                <a href="/paciente/historias-clinicas/<%= paciente.id %>" class="btn btn-outline-secondary">
                                    <i class="fa fa-times"></i> Borrar
                                </a>
                            <% } %>
                        </div>

                
                        <div class="mb-3">
                            <a class="btn btn-agregar" href="/paciente/<%= paciente.id %>/historia-clinica/agregar">
                                <i class="fa-solid fa-plus"></i>
                                <span>Nueva Historia Clínica</span>
                            </a>
                        </div>
                    </div>

                    <div class="contenedor-his-clinica">
                        <% historias.forEach(h => { %>
                            <article>
                                <div>
                                    <h5><strong>Paciente:</strong> <%= paciente.nombre %> - <strong>Nro. Afiliado:</strong> <%= paciente.nro_afiliado %></h5>
                                    <hr>
                                    <div class="fechaHora">
                                        <% let date = new Date(h.fecha) %>
                                        <div class="fecha">
                                            <i class="fa-regular fa-calendar"></i>
                                            <span><%= date.getDate() %>/<%= date.getMonth()+1 %>/<%= date.getFullYear() %></span>
                                        </div>
                                        <div class="hora">
                                            <i class="fa-regular fa-clock"></i>
                                            <span><%= date.getHours() %>:<%= date.getMinutes() %></span>
                                        </div>
                                    </div>
                                    <p><strong>Motivo de la Consulta</strong><br><%= h.motivo %></p>
                                </div>
                                <a href="/paciente/<%= paciente.id %>/historia-clinica/<%= h.historia_id %>/editar">Ver Detalle</a>
                            </article>
                        <% }); %>
                    </div>


                    <div class="pagination-container">
                    <% if (totalPaginas > 1) { %>
                        <nav class="mt-4 paginador">
                        <ul class="pagination justify-content-center">

                            <% const maxNumeros = 5;
                            let inicio = Math.max(1, pagina - Math.floor(maxNumeros / 2));
                            let fin = inicio + maxNumeros - 1;
                            if (fin > totalPaginas) {
                                fin = totalPaginas;
                                inicio = Math.max(1, fin - maxNumeros + 1);
                            }
                            %>

                            <!-- Flecha anterior -->
                            <li class="page-item <%= pagina === 1 ? 'disabled' : '' %>">
                            <a class="page-link" href="?pagina=<%= pagina - 1 %><%= fecha ? '&fecha=' + fecha : '' %>">
                                &laquo;
                            </a>
                            </li>

                            <!-- Números de página -->
                            <% for (let i = inicio; i <= fin; i++) { %>
                            <li class="page-item <%= i === pagina ? 'active' : '' %>">
                                <a class="page-link" href="?pagina=<%= i %><%= fecha ? '&fecha=' + fecha : '' %>"><%= i %></a>
                            </li>
                            <% } %>

                            <!-- Flecha siguiente -->
                            <li class="page-item <%= pagina === totalPaginas ? 'disabled' : '' %>">
                            <a class="page-link" href="?pagina=<%= pagina + 1 %><%= fecha ? '&fecha=' + fecha : '' %>">
                                &raquo;
                            </a>
                            </li>

                        </ul>
                        </nav>
                    <% } %>
                    </div>
                </div>

                <div id="recetas" class="tab-content" style="display: none;">
        
                    <div class="div-superior">
                        <h3 style="margin: 0; color: #555;">Historial de Recetas</h3>
                        
                        <button class="btn btn-agregar btnAbrirModalReceta" 
                            data-id="<%= paciente.id %>"
                            data-nombre="<%= paciente.nombre %>"
                            data-dni="<%= paciente.dni %>"
                            data-cobertura="<%= paciente.cobertura %>"  data-nro-afiliado="<%= paciente.nro_afiliado %>">
                            <i class="fa-solid fa-plus"></i> Nueva Receta
                        </button>
                    </div>

                    <div class="table-responsive mt-3">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Médico</th>
                                    <th>Tratamiento</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (typeof recetas !== 'undefined' && recetas.length > 0) { %>
                                    <% recetas.forEach(receta => { %>
                                        <tr>
                                            <td><%= new Date(receta.fecha).toLocaleDateString() %></td>
                                            <td><%= receta.nombre_medico %></td>
                                            <td class="col-tratamiento"><%= receta.tratamiento %></td>
                                            <td>
                                                <a href="/receta/ver/<%= receta.id %>" target="_blank" class="btn btn-sm btn-outline-primary" title="Imprimir PDF">
                                                    <i class="fa-solid fa-print"></i>
                                                </a>

                                                <button class="btn btn-sm btn-outline-primary btnEditarReceta" 
                                                    title="Editar Receta"
                                                    data-id="<%= receta.id %>"
                                                    data-fecha="<%= new Date(receta.fecha).toISOString().split('T')[0] %>" 
                                                    data-medico="<%= receta.id_medico %>"
                                                    data-tratamiento="<%= receta.tratamiento %>"
                                                    data-diagnostico="<%= receta.diagnostico %>"
                                                    data-indicaciones="<%= receta.indicaciones %>"
                                                    data-comentarios="<%= receta.comentarios %>"
                                                    data-firma-manuscrita="<%= receta.firma_manuscrita %>"
                                                    data-firma-digital="<%= receta.firma_digital %>"
                                                    data-copias="<%= receta.copias %>"
                                                    data-formato="<%= receta.formato_pdf %>">
                                                    <i class="fa-solid fa-pen-to-square"></i>
                                                </button>

                                                <button class="btn btn-sm btn-outline-danger btnEliminarReceta" 
                                                    title="Eliminar Receta"
                                                    data-id="<%= receta.id %>">
                                                    <i class="fa-solid fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    <% }) %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="4" class="text-center p-4">No hay recetas generadas para este paciente.</td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>

            <% } %>

            

        </div>
    </div>

    <%- include('modalesRecetas') %>


    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    // 1. Lógica para eliminar historias clínicas (Ya estaba ok)
    document.querySelectorAll('.btnEliminar').forEach(button => {
        button.addEventListener('click', async() => {
            const pacienteId = button.getAttribute('data-id');
            if (confirm('¿Estás seguro de que deseas eliminar esta H.C.?')) {
                const response = await fetch(`/historiasclinicas/eliminar/${pacienteId}`, {
                    method: 'DELETE'
                });
                location.reload(); 
            }
        });
    });

    // Función auxiliar
    function quitarAcentos(texto) {
        return texto.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }

    // 2. BUSCADOR DE HISTORIAS CLÍNICAS
    document.addEventListener("input", (e) => {
        if (e.target.matches("#buscador")) {
            const searchTerm = e.target.value.toLowerCase();

            document.querySelectorAll(".contenedor-his-clinica article").forEach((article) => {
                const nombrePaciente = quitarAcentos(article.querySelector("h5").textContent.toLowerCase());
                if (nombrePaciente.includes(searchTerm)) {
                    article.style.display = ""; 
                } else {
                    article.style.display = "none"; 
                }
            });
        }
    }); 

    // ELIMINAR RECETA
    const botonesEliminarReceta = document.querySelectorAll(".btnEliminarReceta");

    if (botonesEliminarReceta.length > 0) {
        botonesEliminarReceta.forEach(btn => {
            btn.addEventListener("click", () => {
                const idReceta = btn.dataset.id;

                Swal.fire({
                    title: '¿Eliminar receta?',
                    text: "Esta acción no se puede deshacer.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        try {
                            const response = await fetch(`/pacientes/receta/eliminar/${idReceta}`, {
                                method: 'DELETE'
                            });
                            
                            const data = await response.json();

                            if (data.success) {
                                Swal.fire(
                                    '¡Eliminado!',
                                    'La receta ha sido eliminada.',
                                    'success'
                                ).then(() => {
                                    location.reload(); 
                                });
                            } else {
                                Swal.fire('Error', data.mensaje, 'error');
                            }
                        } catch (error) {
                            console.error(error);
                            Swal.fire('Error', 'No se pudo conectar con el servidor', 'error');
                        }
                    }
                });
            });
        });
    }

</script>

    <script>
        function cambiarTab(evt, tabName) {
            localStorage.setItem('activeTab', tabName);

            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            tablinks = document.getElementsByClassName("nav-link");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }

            document.getElementById(tabName).style.display = "block";
            
            if (evt) {
                evt.currentTarget.className += " active";
            } else {
                const btn = document.querySelector(`button[onclick*="'${tabName}'"]`);
                if(btn) btn.className += " active";
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
        const lastTab = localStorage.getItem('activeTab') || 'historias';
        
        cambiarTab(null, lastTab);
    });
    </script>

    <script>
    // Esperamos a que todo el HTML esté cargado antes de ejecutar el JS
    document.addEventListener("DOMContentLoaded", () => {
        console.log("DOM Cargado correctamente.");

        // ==========================================
        // LÓGICA DE FIRMAS (CHECKBOXES Y ARCHIVOS)
        // ==========================================
        
        // Variables globales para los archivos
        let archivoManuscritaTemp = null;
        let archivoDigitalTemp = null;
        let tipoFirmaActual = ''; 

        // Referencias del DOM
        const modalArchivo = document.getElementById('modalSubirArchivo');
        const inputArchivo = document.getElementById('inputArchivoFirma');
        const btnConfirmarArchivo = document.getElementById('btnConfirmarArchivo');
        const btnCerrarArchivo = document.querySelector('.cerrar-modal-archivo');
        

        // =======================================================
        // "CREAR RECETA"
        // =======================================================
        const checkManuscritaCrear = document.querySelector('#modalReceta #checkFirmaManuscrita');
        const checkDigitalCrear = document.querySelector('#modalReceta #checkFirmaDigital');
        
        const badgeManuscritaCrear = document.querySelector('#modalReceta #estadoFirmaManuscrita');
        const badgeDigitalCrear = document.querySelector('#modalReceta #estadoFirmaDigital');

        // Función reutilizable para abrir el modal de carga
        function abrirModalCarga(e, tipo) {
            console.log(`Click en checkbox ${tipo} del modal CREAR. Checked: ${e.target.checked}`);
            
            if (e.target.checked) {
                // Configurar modal
                tipoFirmaActual = tipo;
                document.getElementById('tituloModalArchivo').innerText = 
                    tipo === 'manuscrita' ? 'Adjuntar Firma Manuscrita' : 'Adjuntar Firma Digital';
                
                inputArchivo.value = ''; // Limpiar input anterior
                
                // Forzar visualización por encima de todo
                modalArchivo.style.display = 'flex';
                modalArchivo.style.zIndex = '9999'; // Z-index muy alto para asegurar que se vea
            } else {
                // Si desmarca, limpiamos lo que había
                if (tipo === 'manuscrita') {
                    archivoManuscritaTemp = null;
                    badgeManuscritaCrear.textContent = 'Sin archivo';
                    badgeManuscritaCrear.className = 'badge bg-secondary';
                } else {
                    archivoDigitalTemp = null;
                    badgeDigitalCrear.textContent = 'Sin archivo';
                    badgeDigitalCrear.className = 'badge bg-secondary';
                }
            }
        }

        // Asignar eventos a los checkboxes
        if (checkManuscritaCrear) {
            checkManuscritaCrear.addEventListener('change', (e) => abrirModalCarga(e, 'manuscrita'));
        } else {
            console.error("Error: No se encontró #checkFirmaManuscrita dentro de #modalReceta");
        }

        if (checkDigitalCrear) {
            checkDigitalCrear.addEventListener('change', (e) => abrirModalCarga(e, 'digital'));
        } else {
            console.error("Error: No se encontró #checkFirmaDigital dentro de #modalReceta");
        }

        const checkManuscritaEdit = document.getElementById('edit_checkFirmaManuscrita');
        const checkDigitalEdit = document.getElementById('edit_checkFirmaDigital');

        if (checkManuscritaEdit) {
            checkManuscritaEdit.addEventListener('change', (e) => abrirModalCarga(e, 'manuscrita'));
        }
        
        if (checkDigitalEdit) {
            checkDigitalEdit.addEventListener('change', (e) => abrirModalCarga(e, 'digital'));
        }

        // =======================================================
        // LÓGICA DEL MODAL DE CARGA DE ARCHIVO (CONFIRMAR/CERRAR)
        // =======================================================
        
        btnConfirmarArchivo.addEventListener('click', () => {
            if (inputArchivo.files.length > 0) {
                const archivo = inputArchivo.files[0];
                
                if (tipoFirmaActual === 'manuscrita') {
                    archivoManuscritaTemp = archivo;
                    // Actualizar badge visual en el modal de crear
                    if(badgeManuscritaCrear) {
                        badgeManuscritaCrear.textContent = 'Archivo cargado';
                        badgeManuscritaCrear.className = 'badge bg-success';
                    }
                } else {
                    archivoDigitalTemp = archivo;
                    // Actualizar badge visual en el modal de crear
                    if(badgeDigitalCrear) {
                        badgeDigitalCrear.textContent = 'Archivo cargado';
                        badgeDigitalCrear.className = 'badge bg-success';
                    }
                }
                modalArchivo.style.display = 'none';
            } else {
                alert("Por favor seleccione un archivo.");
            }
        });

        btnCerrarArchivo.addEventListener('click', () => {
            modalArchivo.style.display = 'none';
            // Si cierra sin confirmar, desmarcamos el checkbox correspondiente
            if (tipoFirmaActual === 'manuscrita' && !archivoManuscritaTemp) {
                if(checkManuscritaCrear) checkManuscritaCrear.checked = false;
            }
            if (tipoFirmaActual === 'digital' && !archivoDigitalTemp) {
                if(checkDigitalCrear) checkDigitalCrear.checked = false;
            }
        });

        // Cerrar modal archivo
        if(btnCerrarArchivo) {
            btnCerrarArchivo.addEventListener('click', () => {
                modalArchivo.style.display = 'none';
                // Si cierra sin confirmar, desmarcamos
                if (tipoFirmaActual === 'manuscrita' && !archivoManuscritaTemp) checkManuscrita.checked = false;
                if (tipoFirmaActual === 'digital' && !archivoDigitalTemp) checkDigital.checked = false;
            });
        }

        // ==========================================
        // 2. CREAR RECETA (SUBMIT)
        // ==========================================

        const formReceta = document.getElementById('formReceta');
        const modalReceta = document.getElementById("modalReceta");

        if (formReceta) {
            formReceta.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData(formReceta);

                // Adjuntar los archivos manualmente al FormData
                if (archivoManuscritaTemp) formData.append('archivo_manuscrita', archivoManuscritaTemp);
                if (archivoDigitalTemp) formData.append('archivo_digital', archivoDigitalTemp);

                // Asegurar valores de checkboxes
                if(checkManuscritaCrear) formData.set('firma_manuscrita', checkManuscritaCrear.checked);
                if(checkDigitalCrear) formData.set('firma_digital', checkDigitalCrear.checked);

                try {
                    const response = await fetch('/pacientes/receta/crear', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();

                    if (result.success) {
                        Swal.fire('¡Receta Creada!', result.mensaje, 'success').then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire('Error', result.mensaje, 'error');
                    }
                } catch (error) {
                    console.error(error);
                    Swal.fire('Error', 'Error de conexión', 'error');
                }
            });
        }

        // ==========================================
        // 3. ABRIR MODAL NUEVA RECETA
        // ==========================================
        const btnNuevaReceta = document.querySelector("#recetas .btnAbrirModalReceta");
        const cerrarModalNueva = document.querySelector(".cerrar-modal-receta");

        if (btnNuevaReceta && modalReceta) {
            btnNuevaReceta.addEventListener("click", () => {
                // Llenar datos
                document.getElementById("nombrePaciente").textContent = btnNuevaReceta.dataset.nombre;
                document.getElementById("dniPaciente").textContent = btnNuevaReceta.dataset.dni;
                document.getElementById("coberturaPaciente").textContent = btnNuevaReceta.dataset.cobertura;
                document.getElementById("afiliadoPaciente").textContent = btnNuevaReceta.dataset.nroAfiliado;
                document.getElementById("idPacienteReceta").value = btnNuevaReceta.dataset.id;
                
                modalReceta.style.display = "flex";
            });
        }

        if(cerrarModalNueva && modalReceta) {
            cerrarModalNueva.addEventListener("click", () => {
                modalReceta.style.display = "none";
            });
        }

        // ==========================================
        // EDITAR RECETA
        // ==========================================
        const modalEditar = document.getElementById("modalEditarReceta");
        const btnCerrarEditar = document.querySelector(".cerrar-modal-editar");
        const formEditar = document.getElementById("formEditarReceta");
        const botonesEditar = document.querySelectorAll(".btnEditarReceta");

        if(botonesEditar.length > 0 && modalEditar) {
            botonesEditar.forEach(btn => {
                btn.addEventListener("click", () => {
                    // Llenar datos
                    document.getElementById("edit_id_receta").value = btn.dataset.id;
                    document.getElementById("edit_fecha").value = btn.dataset.fecha;
                    document.getElementById("edit_medico").value = btn.dataset.medico;
                    document.getElementById("edit_tratamiento").value = btn.dataset.tratamiento;
                    document.getElementById("edit_diagnostico").value = btn.dataset.diagnostico;
                    document.getElementById("edit_indicaciones").value = btn.dataset.indicaciones;
                    document.getElementById("edit_comentarios").value = btn.dataset.comentarios;

                    const chkManuscrita = document.getElementById("edit_checkFirmaManuscrita");
                    const chkDigital = document.getElementById("edit_checkFirmaDigital");
                    if(chkManuscrita) chkManuscrita.checked = (btn.dataset.firmaManuscrita == '1');
                    if(chkDigital) chkDigital.checked = (btn.dataset.firmaDigital == '1');

                    const copiasVal = btn.dataset.copias; 
                    const radioCopia = document.getElementById(`edit_copia_${copiasVal}`);
                    if(radioCopia) radioCopia.checked = true;

                    modalEditar.style.display = "flex";
                });
            });
        }

        if(btnCerrarEditar && modalEditar) {
            btnCerrarEditar.addEventListener("click", () => {
                modalEditar.style.display = "none";
            });
        }

        // Submit Editar
        if(formEditar) {
            formEditar.addEventListener("submit", async (e) => {
                e.preventDefault();
                
                const formData = new FormData(formEditar);
                
                if (archivoManuscritaTemp) {
                    formData.append('archivo_manuscrita', archivoManuscritaTemp);
                }
                if (archivoDigitalTemp) {
                    formData.append('archivo_digital', archivoDigitalTemp);
                }

                const chkM = document.getElementById("edit_checkFirmaManuscrita");
                const chkD = document.getElementById("edit_checkFirmaDigital");
                
                formData.set('firma_manuscrita', chkM ? chkM.checked : false);
                formData.set('firma_digital', chkD ? chkD.checked : false);

                const idReceta = document.getElementById("edit_id_receta").value;
                formData.set('id_receta', idReceta);

                try {
                    const response = await fetch('/pacientes/receta/editar', {
                        method: 'PUT',

                        body: formData 
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        Swal.fire('Actualizado', 'Receta modificada', 'success').then(() => {
                            archivoManuscritaTemp = null;
                            archivoDigitalTemp = null;
                            location.reload();
                        });
                    } else {
                        Swal.fire('Error', result.mensaje, 'error');
                    }
                } catch (error) {
                    console.error(error);
                    Swal.fire('Error', 'Fallo de conexión', 'error');
                }
            });
        }

        const botonesEliminarReceta = document.querySelectorAll(".btnEliminarReceta");
        if (botonesEliminarReceta.length > 0) {
             botonesEliminarReceta.forEach(btn => {
                btn.addEventListener("click", () => {
                    const idReceta = btn.dataset.id;
                    // ... Tu SweetAlert de eliminar ...
                    Swal.fire({
                        title: '¿Eliminar?',
                        text: "No se puede deshacer",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        confirmButtonText: 'Eliminar'
                    }).then(async (res) => {
                        if(res.isConfirmed) {
                             const resp = await fetch(`/pacientes/receta/eliminar/${idReceta}`, {method: 'DELETE'});
                             const d = await resp.json();
                             if(d.success) location.reload();
                        }
                    })
                });
             });
            }
    }); 
    </script>

</body>
</html>