<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cambiar Contraseña</title>
    <link rel="stylesheet" href="/public/css/usuarios.css">
    <%- include('../commons/head') %>

</head>
<body>
    <div class="contenedor-login">

        <div class="contenedor-logo-lateral">
            <div class="texto-bienvenida">
                <div class="logo"></div>
            </div>
            

            <svg id="fondoWave" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="#005b6f" fill-opacity="1" d="M0,224L60,202.7C120,181,240,139,360,101.3C480,64,600,32,720,58.7C840,85,960,171,1080,181.3C1200,192,1320,128,1380,96L1440,64L1440,320L1380,320C1320,320,1200,320,1080,320C960,320,840,320,720,320C600,320,480,320,360,320C240,320,120,320,60,320L0,320Z"></path></svg>
        </div>

        <div class="login-box">
            <h1>Cambiar contraseña</h1>

                <!-- Formulario para recuperar la contraseña -->
                <form id="formularioRecuperarContraseña" action="/login/cambiarPassword" method="POST">
                
                    <input type="hidden" name="token" value="<%= token %>"> <!-- acá se guarda el token para hacer el cambio -->
                    
                    <div class="form-group">
                        <label for="nuevaPassword">Ingrese su nueva contraseña:</label>
                        <div class="password-container" style="position: relative;">
                            <input type="password" id="nuevaPassword" name="nuevaPassword" 
                                    pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).+$" 
                                    title="La contraseña debe contener al menos una letra mayúscula, una minúscula y un número." 
                                    required>
                            <!-- Icono del ojo -->
                            <i id="togglePassword" class="fas fa-eye-slash" 
                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;" onclick="togglePasswordVisibility()"></i>
                        </div>
                        <!-- Mensaje de error -->
                        <small id="passwordError" class="error-msg" style="color: red; font-size: 0.9em; display: block; margin-top: 5px;"></small>
                    </div>
                    

                    <div class="form-group">
                        <label for="confirmarPassword">Confirma la nueva contraseña:</label>
                        <input type="password" id="confirmarPassword" name="confirmarPassword" required>
                    </div>
                    
                    <button type="submit" class="enviar btn">Cambiar</button>
                </form>
        </div>
    </div>

    <script>
        // Función para alternar visibilidad de la contraseña
        function togglePasswordVisibility() {
            const nuevaPassword = document.getElementById('nuevaPassword');
            const confirmarPassword = document.getElementById('confirmarPassword');
            const eyeIcon = document.getElementById('togglePassword');
        
            // Alternar tipo de ambos campos y actualizar el icono
            const isPassword = nuevaPassword.type === 'password';
            nuevaPassword.type = isPassword ? 'text' : 'password';
            confirmarPassword.type = isPassword ? 'text' : 'password';
            eyeIcon.classList.toggle('fa-eye-slash', !isPassword);
            eyeIcon.classList.toggle('fa-eye', isPassword);
        }
    
        // Validaciones y envío del formulario
        document.getElementById("formularioRecuperarContraseña").addEventListener("submit", async (event) => {
            event.preventDefault();
    
            const token = document.querySelector("input[name='token']").value;
            const nuevaPassword = document.getElementById("nuevaPassword").value;
            const confirmarPassword = document.getElementById("confirmarPassword").value;
            const passwordError = document.getElementById("passwordError");
    
            // Limpia mensajes de error previos
            passwordError.textContent = "";
    
            // Validar contraseñas coinciden
            if (nuevaPassword !== confirmarPassword) {
                return Swal.fire("Error", "Las contraseñas no coinciden", "error");
            }
    
            // Validar requisitos de contraseña
            if (!validatePassword(nuevaPassword)) {
                passwordError.textContent = 
                    "La contraseña debe tener al menos 6 caracteres, una mayúscula, una minúscula y un número.";
                return;
            }
    
            // Función para validar contraseña
            function validatePassword(password) {
                return password.length >= 6 && /[A-Z]/.test(password) && /\d/.test(password);
            }
    
            // Enviar contraseña al servidor
            try {
                const response = await fetch("/loginPacientes/cambiarPassword", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ token, nuevaPassword }),
                });
    
                const data = await response.json();
    
                if (response.ok) {
                    Swal.fire("Éxito", data.message, "success").then(() => {
                        window.location.href = "/loginPacientes";
                    });
                } else {
                    Swal.fire("Error", data.message || "No se pudo cambiar la contraseña", "error");
                }
            } catch (error) {
                Swal.fire("Error", "Error de conexión con el servidor", "error");
            }
        });
    </script>
    
    
</body>
</html>